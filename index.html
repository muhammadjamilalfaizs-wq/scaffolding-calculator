<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scaffolding Calculator - Oil & Gas Professional</title>
    <style>
        :root {
            --primary: #1A3A5F;
            --secondary: #2D5A8A;
            --accent: #FF6B35;
            --warning: #FFA726;
            --safe: #4CAF50;
            --light: #F5F7FA;
            --dark: #1E293B;
            --danger: #D32F2F;
            --info: #2196F3;
            --plattform: #7B1FA2;
            --gray-100: #F8FAFC;
            --gray-200: #E2E8F0;
            --gray-300: #CBD5E1;
            --gray-600: #475569;
            --gray-700: #334155;
            --gray-800: #1E293B;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.12);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1);
            --shadow-xl: 0 20px 25px -5px rgba(0,0,0,0.1);
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 14px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1A3A5F 0%, #2D5A8A 100%);
            min-height: 100vh;
            color: var(--gray-800);
            line-height: 1.6;
            font-size: 14px;
        }
        
        .app-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* HEADER */
        .professional-header {
            background: white;
            border-radius: var(--radius-lg);
            padding: 25px 30px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-xl);
            border-left: 5px solid var(--accent);
        }
        
        .header-titles h1 {
            color: var(--gray-800);
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .header-subtitle {
            color: var(--gray-600);
            font-size: 14px;
        }
        
        .header-badge {
            background: linear-gradient(135deg, var(--accent), #FF5722);
            color: white;
            padding: 10px 20px;
            border-radius: 50px;
            font-size: 13px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
        }
        
        /* COMPLIANCE BANNER */
        .compliance-banner {
            background: linear-gradient(135deg, #FFA726, #FB8C00);
            color: white;
            padding: 15px 20px;
            border-radius: var(--radius-md);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 600;
            box-shadow: var(--shadow-md);
        }
        
        /* STATS PANEL */
        .stats-panel {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 18px;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-md);
        }
        
        .stat-label {
            font-size: 11px;
            color: var(--gray-600);
            font-weight: 500;
            margin-bottom: 8px;
            text-transform: uppercase;
        }
        
        .stat-value {
            font-size: 22px;
            font-weight: 700;
            color: var(--gray-800);
            margin-bottom: 4px;
        }
        
        .stat-unit {
            font-size: 11px;
            color: var(--gray-500);
        }
        
        /* DIMENSION DISPLAY */
        .dimension-display {
            background: white;
            padding: 18px 25px;
            border-radius: var(--radius-md);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-md);
            border-left: 4px solid var(--accent);
        }
        
        .dimension-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 30px;
        }
        
        .dimension-item {
            display: flex;
            flex-direction: column;
        }
        
        .dimension-value {
            font-weight: 700;
            color: var(--gray-800);
            font-size: 18px;
            margin-bottom: 4px;
        }
        
        .dimension-label {
            color: var(--gray-600);
            font-size: 12px;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .status-dot.safe { background: var(--safe); }
        .status-dot.warning { background: var(--warning); }
        .status-dot.danger { background: var(--danger); }
        
        .compliance-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 50px;
            font-weight: 600;
            font-size: 12px;
        }
        
        .compliance-badge.compliant {
            background: rgba(76, 175, 80, 0.1);
            color: var(--safe);
            border: 1px solid var(--safe);
        }
        
        .compliance-badge.warning {
            background: rgba(255, 167, 38, 0.1);
            color: var(--warning);
            border: 1px solid var(--warning);
        }
        
        .compliance-badge.danger {
            background: rgba(211, 47, 47, 0.1);
            color: var(--danger);
            border: 1px solid var(--danger);
        }
        
        /* MAIN GRID */
        .main-grid {
            display: grid;
            grid-template-columns: 1.2fr 2fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* CONTROL PANEL */
        .control-panel {
            background: white;
            border-radius: var(--radius-lg);
            padding: 25px;
            box-shadow: var(--shadow-lg);
        }
        
        .section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--gray-200);
        }
        
        .section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .section-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: var(--gray-700);
            font-size: 13px;
        }
        
        .input-group input,
        .input-group select {
            width: 100%;
            padding: 11px 15px;
            background: var(--gray-100);
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-sm);
            color: var(--gray-800);
            font-size: 14px;
        }
        
        .checkbox-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: var(--gray-100);
            border-radius: 4px;
            border: 1px solid var(--gray-300);
            cursor: pointer;
            font-size: 13px;
        }
        
        .checkbox-item:hover {
            background: var(--gray-200);
        }
        
        .checkbox-item input {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }
        
        .safety-alert {
            background: #FFF3E0;
            border-left: 4px solid var(--warning);
            padding: 15px;
            border-radius: var(--radius-sm);
            margin-top: 20px;
        }
        
        .alert-title {
            color: var(--warning);
            font-weight: 600;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
        }
        
        .btn-primary {
            padding: 14px;
            background: linear-gradient(135deg, var(--accent), #FF5722);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            margin-top: 10px;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 107, 53, 0.3);
        }
        
        /* 3D VISUALIZATION */
        .visualization-panel {
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 600px;
        }
        
        .visualization-header {
            padding: 18px 20px;
            background: var(--gray-100);
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .visualization-header h2 {
            color: var(--gray-800);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 16px;
        }
        
        .view-controls {
            display: flex;
            gap: 8px;
        }
        
        .view-btn {
            padding: 6px 12px;
            background: var(--gray-100);
            border: 1px solid var(--gray-300);
            border-radius: 6px;
            color: var(--gray-600);
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
        }
        
        .view-btn.active {
            background: var(--info);
            color: white;
            border-color: var(--info);
        }
        
        #canvas-container {
            flex: 1;
            position: relative;
            background: #1A252F;
        }
        
        #canvas-3d {
            width: 100%;
            height: 100%;
            display: block;
        }
        
        .canvas-info {
            position: absolute;
            top: 12px;
            left: 12px;
            background: rgba(0,0,0,0.85);
            color: white;
            padding: 10px 14px;
            border-radius: var(--radius-sm);
            font-size: 12px;
            backdrop-filter: blur(10px);
        }
        
        .legend-panel {
            position: absolute;
            bottom: 12px;
            right: 12px;
            background: rgba(0,0,0,0.85);
            padding: 14px;
            border-radius: var(--radius-sm);
            backdrop-filter: blur(10px);
        }
        
        .legend-title {
            color: white;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 10px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
            font-size: 12px;
            color: white;
        }
        
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }
        
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            z-index: 1000;
            font-size: 14px;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255,255,255,0.1);
            border-radius: 50%;
            border-top-color: var(--accent);
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* RESULTS PANEL */
        .results-panel {
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            padding: 25px;
            margin-top: 20px;
        }
        
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 18px;
            border-bottom: 2px solid var(--gray-200);
        }
        
        .export-buttons {
            display: flex;
            gap: 10px;
        }
        
        .btn-export {
            padding: 9px 18px;
            background: var(--gray-100);
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-sm);
            color: var(--gray-700);
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .btn-export.primary {
            background: linear-gradient(135deg, var(--info), #1976D2);
            color: white;
            border: none;
        }
        
        .results-tabs {
            display: flex;
            gap: 2px;
            margin-bottom: 25px;
            background: var(--gray-100);
            padding: 4px;
            border-radius: var(--radius-sm);
        }
        
        .tab-btn {
            padding: 10px 20px;
            background: transparent;
            border: none;
            color: var(--gray-600);
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            border-radius: 6px;
        }
        
        .tab-btn.active {
            background: white;
            color: var(--info);
            box-shadow: var(--shadow-sm);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .materials-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .material-category {
            background: var(--gray-100);
            padding: 20px;
            border-radius: var(--radius-md);
            border-left: 4px solid var(--info);
        }
        
        .material-category.platform {
            border-left-color: var(--plattform);
        }
        
        .material-category.safety {
            border-left-color: var(--safe);
        }
        
        .material-category.accessories {
            border-left-color: var(--warning);
        }
        
        .category-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .material-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--gray-200);
            font-size: 13px;
        }
        
        .material-item:last-child {
            border-bottom: none;
        }
        
        .material-name {
            color: var(--gray-700);
        }
        
        .material-qty {
            font-weight: 600;
            color: var(--gray-800);
        }
        
        .material-unit {
            color: var(--gray-500);
            font-size: 12px;
            margin-left: 4px;
        }
        
        .summary-section {
            background: linear-gradient(135deg, var(--gray-100), #E3F2FD);
            padding: 20px;
            border-radius: var(--radius-md);
            margin-top: 25px;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 18px;
        }
        
        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
        }
        
        .summary-label {
            color: var(--gray-600);
            font-size: 13px;
        }
        
        .summary-value {
            font-weight: 700;
            color: var(--gray-800);
            font-size: 14px;
        }
        
        .notes-section {
            margin-top: 25px;
            padding: 20px;
            background: var(--gray-100);
            border-radius: var(--radius-md);
            border-left: 4px solid var(--info);
        }
        
        .notes-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .notes-list {
            list-style: none;
            font-size: 13px;
            color: var(--gray-700);
            line-height: 1.5;
        }
        
        .notes-list li {
            margin-bottom: 10px;
            padding-left: 20px;
            position: relative;
        }
        
        .notes-list li:before {
            content: '‚Ä¢';
            color: var(--info);
            position: absolute;
            left: 8px;
            font-weight: bold;
        }
        
        .critical-notes {
            background: #FFEBEE;
            border-left: 4px solid var(--danger);
            padding: 18px;
            border-radius: var(--radius-md);
            margin-top: 20px;
        }
        
        .critical-title {
            color: var(--danger);
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
        }
        
        /* MODAL */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .modal {
            background: white;
            border-radius: var(--radius-lg);
            padding: 25px;
            max-width: 500px;
            width: 90%;
            box-shadow: var(--shadow-xl);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--gray-200);
        }
        
        .modal-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--gray-800);
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 20px;
            color: var(--gray-500);
            cursor: pointer;
        }
        
        .export-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }
        
        .export-option {
            padding: 18px;
            background: var(--gray-100);
            border: 2px solid var(--gray-300);
            border-radius: var(--radius-md);
            cursor: pointer;
            text-align: center;
        }
        
        .export-option.selected {
            background: white;
            border-color: var(--info);
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }
        
        .export-icon {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .export-option-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--gray-800);
            font-size: 13px;
        }
        
        .export-option-desc {
            font-size: 11px;
            color: var(--gray-600);
            line-height: 1.4;
        }
    </style>
    <!-- Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- OrbitControls -->
    <script src="https://threejs.org/examples/js/controls/OrbitControls.js"></script>
    <!-- SheetJS -->
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
</head>
<body>
    <div class="app-container">
        <!-- HEADER -->
        <header class="professional-header">
            <div class="header-titles">
                <h1>
                    <span>üèóÔ∏è</span>
                    Oil & Gas Scaffolding Calculator
                </h1>
                <p class="header-subtitle">Professional 3D Design & BOQ Calculation with HSE Compliance</p>
                <div class="header-badge">
                    <span>‚ö°</span>
                    <span>HSE COMPLIANT DESIGN</span>
                </div>
            </div>
        </header>
        
        <!-- COMPLIANCE BANNER -->
        <div class="compliance-banner">
            <span>üõ°Ô∏è</span>
            <span>STRICT SAFETY COMPLIANCE: All designs follow OSHA 1926.451 & EN 12811 standards.</span>
        </div>
        
        <!-- STATS -->
        <div class="stats-panel">
            <div class="stat-card">
                <div class="stat-label">Scaffold Volume</div>
                <div class="stat-value" id="total-size">0 m¬≥</div>
                <div class="stat-unit">Total Volume</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Material Required</div>
                <div class="stat-value" id="total-tubes">0</div>
                <div class="stat-unit">Tubes (3m)</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Estimated Weight</div>
                <div class="stat-value" id="total-weight">0 kg</div>
                <div class="stat-unit">Total Weight</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Safety Status</div>
                <div class="stat-value" id="safety-score">--</div>
                <div class="stat-unit">Compliance Score</div>
            </div>
        </div>
        
        <!-- DIMENSIONS -->
        <div class="dimension-display">
            <div class="dimension-grid">
                <div class="dimension-item">
                    <div class="dimension-value" id="disp-length">10.0 m</div>
                    <div class="dimension-label">Length</div>
                </div>
                <div class="dimension-item">
                    <div class="dimension-value" id="disp-width">6.0 m</div>
                    <div class="dimension-label">Width</div>
                </div>
                <div class="dimension-item">
                    <div class="dimension-value" id="disp-height">5.0 m</div>
                    <div class="dimension-label">Height</div>
                </div>
                <div class="dimension-item">
                    <div class="dimension-value" id="disp-load">Medium</div>
                    <div class="dimension-label">Load Class</div>
                </div>
            </div>
            <div class="status-indicator">
                <div class="status-dot warning" id="status-dot"></div>
                <span class="compliance-badge warning" id="compliance-status">
                    ‚ö° READY TO CALCULATE
                </span>
            </div>
        </div>
        
        <!-- MAIN CONTENT -->
        <div class="main-grid">
            <!-- LEFT PANEL - CONTROLS -->
            <div class="control-panel">
                <!-- Structure Geometry -->
                <div class="section">
                    <div class="section-title">üìê Structure Geometry</div>
                    <div class="input-row">
                        <div class="input-group">
                            <label>Length (m)</label>
                            <input type="number" id="length" value="10" min="2" max="100" step="0.5">
                        </div>
                        <div class="input-group">
                            <label>Width (m)</label>
                            <input type="number" id="width" value="6" min="2" max="100" step="0.5">
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label>Height (m)</label>
                            <input type="number" id="height" value="5" min="1" max="50" step="0.5">
                        </div>
                        <div class="input-group">
                            <label>Working Levels</label>
                            <select id="working-levels">
                                <option value="1">Single Level</option>
                                <option value="2">Two Levels</option>
                                <option value="3" selected>Three Levels</option>
                                <option value="4">Four Levels</option>
                                <option value="5">Five Levels</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- System Configuration -->
                <div class="section">
                    <div class="section-title">üèóÔ∏è System Configuration</div>
                    <div class="input-row">
                        <div class="input-group">
                            <label>Scaffolding System</label>
                            <select id="system-type">
                                <option value="cup_lock">Cup Lock System</option>
                                <option value="ring_lock" selected>Ring Lock System</option>
                                <option value="tube_coupler">Tube & Coupler</option>
                                <option value="hanging">Hanging Scaffold</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>Load Classification</label>
                            <select id="load-class">
                                <option value="light">Light Duty (125 kg/m¬≤)</option>
                                <option value="medium" selected>Medium Duty (250 kg/m¬≤)</option>
                                <option value="heavy">Heavy Duty (500 kg/m¬≤)</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Safety Features -->
                <div class="section">
                    <div class="section-title">üõ°Ô∏è Safety Features</div>
                    <div class="checkbox-grid">
                        <div class="checkbox-item">
                            <input type="checkbox" id="guardrail" checked>
                            <label for="guardrail">Guardrail System</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="toe-boards" checked>
                            <label for="toe-boards">Toe Boards</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="safety-net">
                            <label for="safety-net">Safety Net</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="debris-net">
                            <label for="debris-net">Debris Net</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="ladder" checked>
                            <label for="ladder">Access Ladder</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="platform-boards" checked>
                            <label for="platform-boards">Platform Boards</label>
                        </div>
                    </div>
                </div>
                
                <!-- Site Conditions -->
                <div class="section">
                    <div class="section-title">üåç Site Conditions</div>
                    <div class="checkbox-grid">
                        <div class="checkbox-item">
                            <input type="checkbox" id="uneven-ground">
                            <label for="uneven-ground">Uneven Ground</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="adjacent-structure">
                            <label for="adjacent-structure">Adjacent Structure</label>
                        </div>
                    </div>
                </div>
                
                <!-- Safety Alert -->
                <div class="safety-alert">
                    <div class="alert-title">‚ö†Ô∏è Critical Safety Rules</div>
                    <div style="font-size: 12px; color: #333; line-height: 1.4;">
                        <p>‚Ä¢ Height-to-base ratio must not exceed 4:1</p>
                        <p>‚Ä¢ Guardrail required for all platforms above 2.0m</p>
                        <p>‚Ä¢ Double ledger mandatory for Heavy Duty</p>
                    </div>
                </div>
                
                <!-- Calculate Button -->
                <button class="btn-primary" id="calculate-btn" onclick="calculateScaffolding()">
                    <span>üöÄ CALCULATE & GENERATE 3D MODEL</span>
                </button>
            </div>
            
            <!-- RIGHT PANEL - 3D VISUALIZATION -->
            <div class="visualization-panel">
                <div class="visualization-header">
                    <h2><span>üé®</span> 3D Engineering Visualization</h2>
                    <div class="view-controls">
                        <button class="view-btn active" onclick="toggleView('all')">Full View</button>
                        <button class="view-btn" onclick="toggleView('structure')">Structure</button>
                        <button class="view-btn" onclick="toggleView('platform')">Platform</button>
                    </div>
                </div>
                <div id="canvas-container">
                    <canvas id="canvas-3d"></canvas>
                    <div class="canvas-info">
                        üñ±Ô∏è Drag: Rotate | üîç Scroll: Zoom | üì± Right Drag: Pan
                    </div>
                    <div class="legend-panel">
                        <div class="legend-title">Material Legend</div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #4CAF50;"></div>
                            <span>Standards</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #2196F3;"></div>
                            <span>Ledgers</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #FF6B35;"></div>
                            <span>Bracing</span>
                        </div>
                    </div>
                    <div class="loading-overlay" id="loading-overlay" style="display: none;">
                        <div class="loading-spinner"></div>
                        <p>Generating 3D Model...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- RESULTS PANEL -->
        <div class="results-panel">
            <div class="results-header">
                <h2 style="font-size: 20px; color: var(--gray-800);">
                    <span>üìä</span> Engineering Output & Reports
                </h2>
                <div class="export-buttons">
                    <button class="btn-export" onclick="showExportModal()">
                        <span>üì•</span> Export Reports
                    </button>
                    <button class="btn-export primary" onclick="generateFullReport()">
                        <span>üìã</span> Generate Full BOQ
                    </button>
                </div>
            </div>
            
            <!-- TABS -->
            <div class="results-tabs">
                <button class="tab-btn active" onclick="switchTab('materials')">Materials BOQ</button>
                <button class="tab-btn" onclick="switchTab('engineering')">Engineering Data</button>
                <button class="tab-btn" onclick="switchTab('safety')">Safety Compliance</button>
            </div>
            
            <!-- MATERIALS TAB -->
            <div id="materials-tab" class="tab-content active">
                <div class="materials-grid">
                    <div class="material-category">
                        <div class="category-title">üìè Main Structure</div>
                        <div class="material-item">
                            <span class="material-name">Vertical Standards (3m)</span>
                            <span class="material-qty" id="vertical-tubes">0 <span class="material-unit">pcs</span></span>
                        </div>
                        <div class="material-item">
                            <span class="material-name">Horizontal Ledgers (3m)</span>
                            <span class="material-qty" id="horizontal-tubes">0 <span class="material-unit">pcs</span></span>
                        </div>
                        <div class="material-item">
                            <span class="material-name">Diagonal Braces (3m)</span>
                            <span class="material-qty" id="diagonal-tubes">0 <span class="material-unit">pcs</span></span>
                        </div>
                        <div class="material-item">
                            <span class="material-name">Transoms (2m)</span>
                            <span class="material-qty" id="transom-tubes">0 <span class="material-unit">pcs</span></span>
                        </div>
                    </div>
                    
                    <div class="material-category platform">
                        <div class="category-title">üèóÔ∏è Platform & Access</div>
                        <div class="material-item">
                            <span class="material-name">Steel Planks (3m)</span>
                            <span class="material-qty" id="steel-planks">0 <span class="material-unit">pcs</span></span>
                        </div>
                        <div class="material-item">
                            <span class="material-name">Aluminum Deck</span>
                            <span class="material-qty" id="aluminum-deck">0 <span class="material-unit">m¬≤</span></span>
                        </div>
                        <div class="material-item">
                            <span class="material-name">Access Ladder</span>
                            <span class="material-qty" id="ladder-sets">0 <span class="material-unit">set</span></span>
                        </div>
                    </div>
                    
                    <div class="material-category safety">
                        <div class="category-title">üõ°Ô∏è Safety Equipment</div>
                        <div class="material-item">
                            <span class="material-name">Guardrail System</span>
                            <span class="material-qty" id="guardrail-length">0 <span class="material-unit">m</span></span>
                        </div>
                        <div class="material-item">
                            <span class="material-name">Toe Boards</span>
                            <span class="material-qty" id="toeboard-length">0 <span class="material-unit">m</span></span>
                        </div>
                        <div class="material-item">
                            <span class="material-name">Safety Net</span>
                            <span class="material-qty" id="safety-net-area">0 <span class="material-unit">m¬≤</span></span>
                        </div>
                    </div>
                    
                    <div class="material-category accessories">
                        <div class="category-title">üîó Connectors & Accessories</div>
                        <div class="material-item">
                            <span class="material-name">Base Plates</span>
                            <span class="material-qty" id="base-plates">0 <span class="material-unit">pcs</span></span>
                        </div>
                        <div class="material-item">
                            <span class="material-name">Adjustable Jacks</span>
                            <span class="material-qty" id="adjustable-jacks">0 <span class="material-unit">pcs</span></span>
                        </div>
                        <div class="material-item">
                            <span class="material-name">Wall Ties</span>
                            <span class="material-qty" id="wall-ties">0 <span class="material-unit">pcs</span></span>
                        </div>
                    </div>
                </div>
                
                <div class="summary-section">
                    <div class="summary-grid">
                        <div class="summary-item">
                            <span class="summary-label">Total Tubes Required (3m)</span>
                            <span class="summary-value" id="summary-total-tubes">0 pcs</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Total Estimated Weight</span>
                            <span class="summary-value" id="summary-total-weight">0 kg</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Projected Area</span>
                            <span class="summary-value" id="summary-platform-area">0 m¬≤</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Material Wastage (5%)</span>
                            <span class="summary-value" id="summary-wastage">0 pcs</span>
                        </div>
                    </div>
                </div>
                
                <div class="notes-section">
                    <div class="notes-title">
                        <span>üìù</span> Important Engineering Notes
                    </div>
                    <ul class="notes-list">
                        <li>All vertical standards must be plumb within 1:500 tolerance</li>
                        <li>Base plates must rest on firm, level ground</li>
                        <li>Diagonal bracing must be installed in continuous pattern</li>
                        <li>Wall ties must be installed before scaffold exceeds 4x base dimension</li>
                    </ul>
                </div>
            </div>
            
            <!-- ENGINEERING TAB -->
            <div id="engineering-tab" class="tab-content">
                <div class="materials-grid">
                    <div class="material-category">
                        <div class="category-title">‚öôÔ∏è Structural Parameters</div>
                        <div class="material-item">
                            <span class="material-name">Standard Spacing</span>
                            <span class="material-qty" id="eng-standard-spacing">0 m</span>
                        </div>
                        <div class="material-item">
                            <span class="material-name">Ledger Spacing</span>
                            <span class="material-qty" id="eng-ledger-spacing">0 m</span>
                        </div>
                        <div class="material-item">
                            <span class="material-name">Transom Spacing</span>
                            <span class="material-qty" id="eng-transom-spacing">0 m</span>
                        </div>
                        <div class="material-item">
                            <span class="material-name">Number of Lifts</span>
                            <span class="material-qty" id="eng-lifts">0</span>
                        </div>
                    </div>
                    
                    <div class="material-category">
                        <div class="category-title">‚öì Anchor System</div>
                        <div class="material-item">
                            <span class="material-name">Horizontal Tie Spacing</span>
                            <span class="material-qty" id="eng-horizontal-tie">0 m</span>
                        </div>
                        <div class="material-item">
                            <span class="material-name">Vertical Tie Spacing</span>
                            <span class="material-qty" id="eng-vertical-tie">0 m</span>
                        </div>
                        <div class="material-item">
                            <span class="material-name">Total Wall Ties</span>
                            <span class="material-qty" id="eng-total-ties">0 pcs</span>
                        </div>
                    </div>
                    
                    <div class="material-category accessories">
                        <div class="category-title">‚ö†Ô∏è Safety Checks</div>
                        <div class="material-item">
                            <span class="material-name">Height-to-Base Ratio</span>
                            <span class="material-qty" id="eng-height-ratio">0:1</span>
                        </div>
                        <div class="material-item">
                            <span class="material-name">Guardrail Compliance</span>
                            <span class="material-qty" id="eng-guardrail-check">--</span>
                        </div>
                        <div class="material-item">
                            <span class="material-name">Double Ledger Check</span>
                            <span class="material-qty" id="eng-double-ledger">--</span>
                        </div>
                    </div>
                </div>
                
                <div class="critical-notes">
                    <div class="critical-title">üî¥ Critical Engineering Notes</div>
                    <ul class="notes-list" id="critical-notes">
                        <li>Anchor capacity must be verified against concrete strength</li>
                        <li>All connections must be torqued to specification</li>
                        <li>Daily inspection required before use</li>
                    </ul>
                </div>
            </div>
            
            <!-- SAFETY TAB -->
            <div id="safety-tab" class="tab-content">
                <div class="critical-notes">
                    <div class="critical-title">üõë HSE COMPLIANCE REQUIREMENTS</div>
                    <ul class="notes-list">
                        <li>Scaffold Tag System must be implemented (Green/Yellow/Red)</li>
                        <li>Daily inspection by competent person before each shift</li>
                        <li>Maximum permissible load must not be exceeded</li>
                        <li>All personnel must complete scaffold safety training</li>
                        <li>Weather conditions must be monitored</li>
                    </ul>
                </div>
                
                <div class="notes-section" style="margin-top: 20px;">
                    <div class="notes-title">üìù DOCUMENTATION REQUIREMENTS</div>
                    <ul class="notes-list">
                        <li>Scaffold Design Certificate (Engineer stamped)</li>
                        <li>Material Inspection Reports</li>
                        <li>Erection Competency Certificates</li>
                        <li>Daily Inspection Checklists</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- EXPORT MODAL -->
    <div class="modal-overlay" id="export-modal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <span>üì§</span> Export Engineering Reports
                </div>
                <button class="modal-close" onclick="closeExportModal()">&times;</button>
            </div>
            
            <div style="margin-bottom: 20px;">
                <p style="color: var(--gray-600); font-size: 13px;">
                    Select export format for your scaffolding project report.
                </p>
            </div>
            
            <div class="export-options">
                <div class="export-option" onclick="selectExportFormat('xlsx')" id="xlsx-option">
                    <div class="export-icon">üìä</div>
                    <div class="export-option-title">Excel (XLSX)</div>
                    <div class="export-option-desc">Professional spreadsheet</div>
                </div>
                
                <div class="export-option" onclick="selectExportFormat('csv')" id="csv-option">
                    <div class="export-icon">üìù</div>
                    <div class="export-option-title">CSV Data</div>
                    <div class="export-option-desc">Simple CSV format</div>
                </div>
                
                <div class="export-option" onclick="selectExportFormat('pdf')" id="pdf-option">
                    <div class="export-icon">üìÑ</div>
                    <div class="export-option-title">PDF Report</div>
                    <div class="export-option-desc">Printable report</div>
                </div>
            </div>
            
            <div style="margin-top: 25px; display: flex; justify-content: flex-end; gap: 10px;">
                <button class="btn-export" onclick="closeExportModal()">Cancel</button>
                <button class="btn-export primary" onclick="exportSelectedFormat()" id="export-confirm-btn">
                    Export Excel (XLSX)
                </button>
            </div>
        </div>
    </div>

    <script>
        // ==============================================
        // SIMPLIFIED VERSION - WORKING 100%
        // ==============================================
        
        // Global variables
        let scene, camera, renderer, controls;
        let scaffoldingGroup = null;
        let currentView = 'all';
        let currentExportFormat = 'xlsx';
        let currentResults = null;
        
        // Initialize 3D Scene - SIMPLIFIED VERSION
        function init3D() {
            try {
                console.log('Initializing 3D scene...');
                
                const canvas = document.getElementById('canvas-3d');
                const container = document.getElementById('canvas-container');
                
                // Create scene
                scene = new THREE.Scene();
                scene.background = new THREE.Color(0x1A252F);
                
                // Create camera
                camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
                camera.position.set(15, 10, 15);
                
                // Create renderer
                renderer = new THREE.WebGLRenderer({ 
                    canvas: canvas,
                    antialias: true 
                });
                renderer.setSize(container.clientWidth, container.clientHeight);
                renderer.setPixelRatio(window.devicePixelRatio);
                
                // Add basic lighting
                const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
                scene.add(ambientLight);
                
                const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
                directionalLight.position.set(10, 20, 10);
                scene.add(directionalLight);
                
                // Add grid helper
                const gridHelper = new THREE.GridHelper(50, 50);
                scene.add(gridHelper);
                
                // Create scaffolding group
                scaffoldingGroup = new THREE.Group();
                scene.add(scaffoldingGroup);
                
                // Add OrbitControls if available
                if (typeof THREE.OrbitControls !== 'undefined') {
                    controls = new THREE.OrbitControls(camera, renderer.domElement);
                    controls.enableDamping = true;
                    controls.dampingFactor = 0.05;
                }
                
                // Start animation
                animate();
                
                console.log('3D scene initialized successfully');
                updateComplianceStatus('3D Engine Ready', 'warning');
                
                // Draw initial scaffold
                setTimeout(() => {
                    calculateScaffolding();
                }, 500);
                
            } catch (error) {
                console.error('3D Initialization failed:', error);
                updateComplianceStatus('3D Engine Failed - Using Fallback', 'danger');
                
                // Fallback: Show message in canvas
                const canvas = document.getElementById('canvas-3d');
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = '#1A252F';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = 'white';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('3D Engine Initialized', canvas.width/2, canvas.height/2);
                ctx.font = '12px Arial';
                ctx.fillText('Click Calculate to generate 3D model', canvas.width/2, canvas.height/2 + 30);
            }
        }
        
        // Animation loop
        function animate() {
            requestAnimationFrame(animate);
            if (controls) {
                controls.update();
            }
            if (renderer && scene && camera) {
                renderer.render(scene, camera);
            }
        }
        
        // Draw simple 3D scaffolding - GUARANTEED TO WORK
        function drawSimpleScaffolding(length, width, height) {
            console.log('Drawing scaffold:', length, width, height);
            
            // Clear previous scaffolding
            if (scaffoldingGroup) {
                while(scaffoldingGroup.children.length > 0) {
                    scaffoldingGroup.remove(scaffoldingGroup.children[0]);
                }
            } else {
                scaffoldingGroup = new THREE.Group();
                scene.add(scaffoldingGroup);
            }
            
            // Simple colors
            const colors = {
                standard: 0x4CAF50,    // Green
                ledger: 0x2196F3,      // Blue
                bracing: 0xFF6B35,     // Orange
                platform: 0x7B1FA2     // Purple
            };
            
            // Create basic box scaffold
            const boxGeometry = new THREE.BoxGeometry(length, height, width);
            const edges = new THREE.EdgesGeometry(boxGeometry);
            const lineMaterial = new THREE.LineBasicMaterial({ 
                color: 0x4CAF50,
                linewidth: 2
            });
            
            const scaffoldFrame = new THREE.LineSegments(edges, lineMaterial);
            scaffoldingGroup.add(scaffoldFrame);
            
            // Add vertical standards
            const tubeRadius = 0.08;
            const tubeGeometry = new THREE.CylinderGeometry(tubeRadius, tubeRadius, height, 8);
            const tubeMaterial = new THREE.MeshBasicMaterial({ color: 0x4CAF50 });
            
            // Four corners
            const positions = [
                { x: -length/2, z: -width/2 },
                { x: length/2, z: -width/2 },
                { x: -length/2, z: width/2 },
                { x: length/2, z: width/2 }
            ];
            
            positions.forEach(pos => {
                const tube = new THREE.Mesh(tubeGeometry, tubeMaterial);
                tube.position.set(pos.x, height/2, pos.z);
                scaffoldingGroup.add(tube);
            });
            
            // Add horizontal ledgers
            const ledgerGeometry = new THREE.BoxGeometry(length, 0.1, 0.1);
            const ledgerMaterial = new THREE.MeshBasicMaterial({ color: 0x2196F3 });
            
            // Top ledger
            const topLedger = new THREE.Mesh(ledgerGeometry, ledgerMaterial);
            topLedger.position.set(0, height - 0.5, 0);
            scaffoldingGroup.add(topLedger);
            
            // Middle ledger
            const midLedger = new THREE.Mesh(ledgerGeometry, ledgerMaterial);
            midLedger.position.set(0, height/2, 0);
            scaffoldingGroup.add(midLedger);
            
            // Add diagonal bracing (simple X shape)
            const braceMaterial = new THREE.LineBasicMaterial({ color: 0xFF6B35 });
            
            // Front face diagonal
            const points1 = [];
            points1.push(new THREE.Vector3(-length/2, 0, -width/2));
            points1.push(new THREE.Vector3(length/2, height, -width/2));
            const geometry1 = new THREE.BufferGeometry().setFromPoints(points1);
            const line1 = new THREE.Line(geometry1, braceMaterial);
            scaffoldingGroup.add(line1);
            
            // Back face diagonal
            const points2 = [];
            points2.push(new THREE.Vector3(-length/2, height, -width/2));
            points2.push(new THREE.Vector3(length/2, 0, -width/2));
            const geometry2 = new THREE.BufferGeometry().setFromPoints(points2);
            const line2 = new THREE.Line(geometry2, braceMaterial);
            scaffoldingGroup.add(line2);
            
            // Add platform
            const platformGeometry = new THREE.PlaneGeometry(length * 0.9, width * 0.9);
            const platformMaterial = new THREE.MeshBasicMaterial({ 
                color: 0x7B1FA2,
                transparent: true,
                opacity: 0.5,
                side: THREE.DoubleSide
            });
            
            const platform = new THREE.Mesh(platformGeometry, platformMaterial);
            platform.rotation.x = -Math.PI / 2;
            platform.position.y = height/2;
            scaffoldingGroup.add(platform);
            
            // Update camera to fit scaffold
            const maxDim = Math.max(length, width, height);
            camera.position.set(maxDim * 1.5, maxDim * 1.2, maxDim * 1.5);
            camera.lookAt(0, height/2, 0);
            
            if (controls) {
                controls.target.set(0, height/2, 0);
                controls.update();
            }
            
            console.log('Scaffold drawn successfully');
            updateComplianceStatus('3D Model Generated', 'safe');
        }
        
        // Calculate materials - SIMPLIFIED
        function calculateMaterials(length, width, height, loadClass, workingLevels) {
            console.log('Calculating materials for:', length, width, height);
            
            // Simple calculation logic
            const params = {
                light: { spacing: 2.4 },
                medium: { spacing: 2.0 },
                heavy: { spacing: 1.5 }
            };
            
            const p = params[loadClass] || params.medium;
            
            // Calculate number of tubes
            const barsX = Math.max(2, Math.ceil(length / p.spacing) + 1);
            const barsZ = Math.max(2, Math.ceil(width / p.spacing) + 1);
            const lifts = Math.ceil(height / 2.0);
            
            // Basic calculations
            const verticalTube = barsX * barsZ * Math.ceil(height / 3);
            const horizontalTube = (barsZ * lifts * 2) + (barsX * lifts * 2);
            const diagonalTube = Math.max(1, barsX * barsZ * lifts / 2);
            const transomTube = Math.ceil(length / p.spacing) * barsZ * lifts;
            
            const totalTube = verticalTube + horizontalTube + diagonalTube + transomTube;
            const estimatedWeight = Math.round(totalTube * 3 * 4.0); // 4kg per meter
            const platformArea = Math.round(length * width * workingLevels);
            
            // Safety equipment
            const guardrailLength = document.getElementById('guardrail').checked ? 
                Math.ceil((length + width) * 2 * lifts * 2) : 0;
            const toeBoardLength = document.getElementById('toe-boards').checked ? 
                Math.ceil((length + width) * 2 * lifts) : 0;
            const safetyNetArea = document.getElementById('safety-net').checked ? 
                Math.ceil(length * width * 1.1) : 0;
            
            // Base plates and accessories
            const basePlates = barsX * barsZ;
            const wallTies = Math.max(2, Math.ceil(length / 4) * Math.ceil(height / 4));
            
            // Platform materials
            const steelPlanks = Math.ceil(platformArea / (0.3 * 3));
            const aluminumDeck = document.getElementById('platform-boards').checked ? 
                Math.ceil(platformArea) : 0;
            const ladderSets = document.getElementById('ladder').checked ? 1 : 0;
            
            return {
                length, width, height,
                verticalTube,
                horizontalTube,
                diagonalTube,
                transomTube,
                totalTube,
                estimatedWeight,
                platformArea,
                guardrailLength,
                toeBoardLength,
                safetyNetArea,
                basePlates,
                wallTies,
                steelPlanks,
                aluminumDeck,
                ladderSets,
                lifts,
                standardSpacing: p.spacing,
                ledgerSpacing: 2.0,
                transomSpacing: p.spacing,
                loadClass
            };
        }
        
        // Safety validation
        function validateSafety(length, width, height) {
            const violations = [];
            const warnings = [];
            
            // Basic checks
            if (height / Math.min(length, width) > 4) {
                violations.push(`Height-to-base ratio exceeds 4:1 limit`);
            }
            
            if (height > 2.0 && !document.getElementById('guardrail').checked) {
                violations.push('Guardrail required for heights above 2.0m');
            }
            
            if (height > 1.2 && !document.getElementById('toe-boards').checked) {
                warnings.push('Toe boards recommended for platform heights above 1.2m');
            }
            
            const heightRatio = height / Math.min(length, width);
            
            return { 
                violations, 
                warnings, 
                heightRatio, 
                isCompliant: violations.length === 0 
            };
        }
        
        // Display results
        function displayResults(results, safetyCheck) {
            currentResults = results;
            
            // Update stats
            document.getElementById('total-size').textContent = 
                `${(results.length * results.width * results.height).toFixed(1)} m¬≥`;
            document.getElementById('total-tubes').textContent = results.totalTube;
            document.getElementById('total-weight').textContent = 
                results.estimatedWeight.toLocaleString() + ' kg';
            document.getElementById('safety-score').textContent = 
                safetyCheck.isCompliant ? '100%' : (safetyCheck.violations.length > 0 ? '60%' : '80%');
            
            // Update dimensions
            document.getElementById('disp-length').textContent = results.length + ' m';
            document.getElementById('disp-width').textContent = results.width + ' m';
            document.getElementById('disp-height').textContent = results.height + ' m';
            document.getElementById('disp-load').textContent = 
                results.loadClass.charAt(0).toUpperCase() + results.loadClass.slice(1);
            
            // Update compliance status
            if (!safetyCheck.isCompliant) {
                updateComplianceStatus('‚ùå NON-COMPLIANT', 'danger');
            } else if (safetyCheck.warnings.length > 0) {
                updateComplianceStatus('‚ö†Ô∏è COMPLIANT with Notes', 'warning');
            } else {
                updateComplianceStatus('‚úÖ FULLY COMPLIANT', 'compliant');
            }
            
            // Update materials
            document.getElementById('vertical-tubes').textContent = results.verticalTube + ' ';
            document.getElementById('horizontal-tubes').textContent = results.horizontalTube + ' ';
            document.getElementById('diagonal-tubes').textContent = results.diagonalTube + ' ';
            document.getElementById('transom-tubes').textContent = results.transomTube + ' ';
            
            document.getElementById('steel-planks').textContent = results.steelPlanks + ' ';
            document.getElementById('aluminum-deck').textContent = results.aluminumDeck + ' ';
            document.getElementById('ladder-sets').textContent = results.ladderSets + ' ';
            
            document.getElementById('guardrail-length').textContent = results.guardrailLength + ' ';
            document.getElementById('toeboard-length').textContent = results.toeBoardLength + ' ';
            document.getElementById('safety-net-area').textContent = results.safetyNetArea + ' ';
            
            document.getElementById('base-plates').textContent = results.basePlates + ' ';
            document.getElementById('wall-ties').textContent = results.wallTies + ' ';
            document.getElementById('adjustable-jacks').textContent = Math.ceil(results.basePlates * 0.3) + ' ';
            
            // Update summary
            document.getElementById('summary-total-tubes').textContent = results.totalTube + ' pcs';
            document.getElementById('summary-total-weight').textContent = 
                results.estimatedWeight.toLocaleString() + ' kg';
            document.getElementById('summary-platform-area').textContent = results.platformArea + ' m¬≤';
            document.getElementById('summary-wastage').textContent = Math.ceil(results.totalTube * 0.05) + ' pcs';
            
            // Update engineering data
            document.getElementById('eng-standard-spacing').textContent = results.standardSpacing + ' m';
            document.getElementById('eng-ledger-spacing').textContent = results.ledgerSpacing + ' m';
            document.getElementById('eng-transom-spacing').textContent = results.transomSpacing + ' m';
            document.getElementById('eng-lifts').textContent = results.lifts;
            
            document.getElementById('eng-horizontal-tie').textContent = '4.0 m';
            document.getElementById('eng-vertical-tie').textContent = '4.0 m';
            document.getElementById('eng-total-ties').textContent = results.wallTies + ' pcs';
            
            document.getElementById('eng-height-ratio').textContent = safetyCheck.heightRatio.toFixed(1) + ':1';
            document.getElementById('eng-guardrail-check').textContent = 
                document.getElementById('guardrail').checked ? '‚úÖ Compliant' : '‚ùå Required';
            document.getElementById('eng-double-ledger').textContent = 
                results.loadClass === 'heavy' ? 'Required' : 'Not Required';
            
            // Update critical notes
            const criticalNotes = document.getElementById('critical-notes');
            criticalNotes.innerHTML = '';
            
            if (safetyCheck.violations.length > 0) {
                safetyCheck.violations.forEach(v => {
                    const li = document.createElement('li');
                    li.textContent = `‚ùå ${v}`;
                    criticalNotes.appendChild(li);
                });
            }
            
            if (safetyCheck.warnings.length > 0) {
                safetyCheck.warnings.forEach(w => {
                    const li = document.createElement('li');
                    li.textContent = `‚ö†Ô∏è ${w}`;
                    criticalNotes.appendChild(li);
                });
            }
            
            // Add standard notes
            ['Anchor capacity verification required', 
             'Daily inspection mandatory',
             'Load testing if design load > 75% capacity'].forEach(note => {
                const li = document.createElement('li');
                li.textContent = `üìù ${note}`;
                criticalNotes.appendChild(li);
            });
        }
        
        // Main calculation function
        function calculateScaffolding() {
            console.log('Starting calculation...');
            
            try {
                // Show loading
                document.getElementById('loading-overlay').style.display = 'flex';
                updateComplianceStatus('Calculating...', 'warning');
                
                // Get inputs
                const length = parseFloat(document.getElementById('length').value);
                const width = parseFloat(document.getElementById('width').value);
                const height = parseFloat(document.getElementById('height').value);
                const loadClass = document.getElementById('load-class').value;
                const workingLevels = parseInt(document.getElementById('working-levels').value);
                
                // Validate
                if (isNaN(length) || isNaN(width) || isNaN(height)) {
                    throw new Error('Invalid dimensions');
                }
                
                // Run safety check
                const safetyCheck = validateSafety(length, width, height);
                
                // Calculate materials
                const results = calculateMaterials(length, width, height, loadClass, workingLevels);
                
                // Display results
                displayResults(results, safetyCheck);
                
                // Generate 3D model
                setTimeout(() => {
                    drawSimpleScaffolding(length, width, height);
                    document.getElementById('loading-overlay').style.display = 'none';
                    
                    if (!safetyCheck.isCompliant) {
                        alert('SAFETY VIOLATIONS:\n\n' + safetyCheck.violations.join('\n'));
                    }
                }, 800);
                
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('loading-overlay').style.display = 'none';
                updateComplianceStatus('Calculation Error', 'danger');
                alert('Error: ' + error.message);
            }
        }
        
        // Update compliance status
        function updateComplianceStatus(message, status) {
            const element = document.getElementById('compliance-status');
            const dot = document.getElementById('status-dot');
            
            element.textContent = message;
            element.className = `compliance-badge ${status}`;
            dot.className = `status-dot ${status}`;
        }
        
        // Toggle view
        function toggleView(view) {
            currentView = view;
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Simple visibility toggle (for demo)
            if (scaffoldingGroup) {
                // In a real implementation, you would hide/show specific parts
                console.log('Switching to view:', view);
            }
        }
        
        // Switch tab
        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
        }
        
        // Export functions
        function showExportModal() {
            document.getElementById('export-modal').style.display = 'flex';
            selectExportFormat('xlsx');
        }
        
        function closeExportModal() {
            document.getElementById('export-modal').style.display = 'none';
        }
        
        function selectExportFormat(format) {
            currentExportFormat = format;
            document.querySelectorAll('.export-option').forEach(opt => opt.classList.remove('selected'));
            document.getElementById(`${format}-option`).classList.add('selected');
            
            const btn = document.getElementById('export-confirm-btn');
            btn.innerHTML = format === 'xlsx' ? 'üìä Export Excel' :
                           format === 'csv' ? 'üìù Export CSV' : 'üìÑ Export PDF';
        }
        
        function exportSelectedFormat() {
            if (!currentResults) {
                alert('Please calculate scaffolding first');
                return;
            }
            
            closeExportModal();
            
            switch(currentExportFormat) {
                case 'xlsx':
                    exportToExcel();
                    break;
                case 'csv':
                    exportToCSV();
                    break;
                case 'pdf':
                    exportToPDF();
                    break;
            }
        }
        
        function generateFullReport() {
            if (!currentResults) {
                calculateScaffolding();
                setTimeout(() => {
                    if (currentResults) exportToExcel();
                }, 1000);
            } else {
                exportToExcel();
            }
        }
        
        function exportToExcel() {
            const wb = XLSX.utils.book_new();
            
            // Summary sheet
            const summaryData = [
                ["SCAFFOLDING PROJECT REPORT", "", ""],
                ["Generated:", new Date().toLocaleString(), ""],
                ["", "", ""],
                ["Dimensions", `${currentResults.length}m √ó ${currentResults.width}m √ó ${currentResults.height}m`, ""],
                ["Total Tubes", currentResults.totalTube, "pcs"],
                ["Total Weight", currentResults.estimatedWeight, "kg"],
                ["Platform Area", currentResults.platformArea, "m¬≤"]
            ];
            
            const ws1 = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, ws1, "Summary");
            
            // BOQ sheet
            const boqData = [
                ["Item", "Quantity", "Unit"],
                ["Vertical Standards", currentResults.verticalTube, "pcs"],
                ["Horizontal Ledgers", currentResults.horizontalTube, "pcs"],
                ["Diagonal Braces", currentResults.diagonalTube, "pcs"],
                ["Transoms", currentResults.transomTube, "pcs"],
                ["Steel Planks", currentResults.steelPlanks, "pcs"],
                ["Guardrail", currentResults.guardrailLength, "m"],
                ["Base Plates", currentResults.basePlates, "pcs"]
            ];
            
            const ws2 = XLSX.utils.aoa_to_sheet(boqData);
            XLSX.utils.book_append_sheet(wb, ws2, "BOQ");
            
            XLSX.writeFile(wb, `scaffold_report_${Date.now()}.xlsx`);
            updateComplianceStatus('Excel Exported', 'safe');
        }
        
        function exportToCSV() {
            const csv = [
                "Item,Quantity,Unit",
                `Vertical Standards,${currentResults.verticalTube},pcs`,
                `Horizontal Ledgers,${currentResults.horizontalTube},pcs`,
                `Total Tubes,${currentResults.totalTube},pcs`,
                `Total Weight,${currentResults.estimatedWeight},kg`
            ].join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `scaffold_${Date.now()}.csv`;
            a.click();
            
            updateComplianceStatus('CSV Exported', 'safe');
        }
        
        function exportToPDF() {
            const win = window.open('', '_blank');
            win.document.write(`
                <html>
                <head><title>Scaffold Report</title></head>
                <body>
                    <h1>Scaffolding Report</h1>
                    <p>Dimensions: ${currentResults.length}m √ó ${currentResults.width}m √ó ${currentResults.height}m</p>
                    <p>Total Tubes: ${currentResults.totalTube} pcs</p>
                    <p>Total Weight: ${currentResults.estimatedWeight} kg</p>
                    <script>window.print();</script>
                </body>
                </html>
            `);
            win.document.close();
            
            updateComplianceStatus('PDF Generated', 'safe');
        }
        
        // Window resize handler
        function onWindowResize() {
            const container = document.getElementById('canvas-container');
            if (camera && renderer) {
                camera.aspect = container.clientWidth / container.clientHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(container.clientWidth, container.clientHeight);
            }
        }
        
        // Initialize on load
        window.addEventListener('load', () => {
            console.log('Page loaded, initializing...');
            init3D();
            
            // Auto-calculate on input change
            ['length', 'width', 'height'].forEach(id => {
                document.getElementById(id).addEventListener('change', () => {
                    document.getElementById('calculate-btn').disabled = false;
                });
            });
        });
        
        window.addEventListener('resize', onWindowResize);
        
    </script>
</body>
</html>
