
<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scaffolding Calculator & 3D Planner - Oil & Gas Edition</title>
    <style>
        :root {
            --primary: #2C3E50;
            --secondary: #34495E;
            --accent: #E74C3C;
            --warning: #F39C12;
            --safe: #27AE60;
            --light: #ECF0F1;
            --dark: #2C3E50;
            --danger: #C0392B;
            --info: #3498DB;
            --plattform: #8E44AD;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2c3e50 0%, #4a6491 100%);
            min-height: 100vh;
            color: var(--light);
            line-height: 1.6;
            font-size: 14px;
        }
        
        .app-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 25px;
            padding: 25px;
            background: rgba(44, 62, 80, 0.9);
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            border-left: 5px solid var(--accent);
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: '‚ö° OIL & GAS EDITION ‚ö°';
            position: absolute;
            top: 0;
            right: 0;
            background: var(--accent);
            color: white;
            padding: 5px 15px;
            font-size: 11px;
            font-weight: bold;
            letter-spacing: 1px;
        }
        
        .header h1 {
            color: white;
            font-size: 28px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .header .subtitle {
            color: #BDC3C7;
            font-size: 15px;
            font-weight: 300;
        }
        
        .compliance-banner {
            background: linear-gradient(135deg, var(--warning), #E67E22);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            font-weight: 600;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1.2fr 2fr;
            gap: 25px;
            margin-bottom: 25px;
        }
        
        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
        
        .control-panel {
            background: rgba(44, 62, 80, 0.9);
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .section {
            background: rgba(52, 73, 94, 0.7);
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid var(--info);
        }
        
        .section.danger-zone {
            border-left-color: var(--danger);
            background: rgba(192, 57, 43, 0.1);
        }
        
        .section-title {
            color: white;
            margin-bottom: 15px;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #BDC3C7;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .input-group input,
        .input-group select {
            width: 100%;
            padding: 10px 12px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 6px;
            color: white;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .input-group input:focus,
        .input-group select:focus {
            outline: none;
            border-color: var(--info);
            background: rgba(255,255,255,0.15);
        }
        
        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .checkbox-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: rgba(255,255,255,0.05);
            border-radius: 4px;
            border: 1px solid rgba(255,255,255,0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 13px;
        }
        
        .checkbox-item:hover {
            background: rgba(255,255,255,0.1);
            border-color: var(--info);
        }
        
        .checkbox-item input {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }
        
        .btn-primary {
            padding: 14px;
            background: linear-gradient(135deg, var(--accent), #C0392B);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            letter-spacing: 0.5px;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
        }
        
        .btn-primary:disabled {
            background: #7F8C8D;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .visualization-panel {
            background: rgba(44, 62, 80, 0.9);
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: 600px;
        }
        
        .visualization-header {
            padding: 20px;
            background: rgba(52, 73, 94, 0.9);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .visualization-header h2 {
            color: white;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .view-controls {
            display: flex;
            gap: 10px;
        }
        
        .view-btn {
            padding: 8px 15px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 4px;
            color: white;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }
        
        .view-btn.active {
            background: var(--info);
            border-color: var(--info);
        }
        
        .view-btn:hover {
            background: rgba(255,255,255,0.2);
        }
        
        #canvas-container {
            flex: 1;
            position: relative;
            background: #1A252F;
        }
        
        #canvas-3d {
            width: 100%;
            height: 100%;
            display: block;
        }
        
        .canvas-info {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 6px;
            font-size: 12px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .legend {
            position: absolute;
            bottom: 15px;
            right: 15px;
            background: rgba(0,0,0,0.8);
            padding: 12px;
            border-radius: 6px;
            font-size: 11px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
        }
        
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }
        
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            z-index: 1000;
            font-size: 14px;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255,255,255,0.1);
            border-radius: 50%;
            border-top-color: var(--accent);
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .results-panel {
            background: rgba(44, 62, 80, 0.9);
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            padding: 25px;
            margin-top: 25px;
        }
        
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .export-dropdown {
            position: relative;
            display: inline-block;
        }
        
        .export-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--secondary);
            min-width: 200px;
            border-radius: 6px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 1000;
            overflow: hidden;
        }
        
        .export-menu.show {
            display: block;
        }
        
        .export-btn {
            width: auto;
            padding: 10px 20px;
            margin: 0;
        }
        
        .export-option {
            padding: 12px 20px;
            color: white;
            background: transparent;
            border: none;
            width: 100%;
            text-align: left;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background 0.3s ease;
        }
        
        .export-option:hover {
            background: rgba(255,255,255,0.1);
        }
        
        .compliance-status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 13px;
        }
        
        .status-compliant {
            background: rgba(39, 174, 96, 0.2);
            color: var(--safe);
            border: 1px solid var(--safe);
        }
        
        .status-warning {
            background: rgba(243, 156, 18, 0.2);
            color: var(--warning);
            border: 1px solid var(--warning);
        }
        
        .status-danger {
            background: rgba(192, 57, 43, 0.2);
            color: var(--danger);
            border: 1px solid var(--danger);
        }
        
        .results-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 5px;
        }
        
        .tab-btn {
            padding: 10px 20px;
            background: transparent;
            border: none;
            color: #BDC3C7;
            cursor: pointer;
            font-size: 14px;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        
        .tab-btn.active {
            color: white;
            border-bottom-color: var(--accent);
            background: rgba(255,255,255,0.05);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .materials-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .material-category {
            background: rgba(52, 73, 94, 0.7);
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid var(--info);
        }
        
        .material-category.platform {
            border-left-color: var(--plattform);
        }
        
        .material-category.safety {
            border-left-color: var(--safe);
        }
        
        .material-category.accessories {
            border-left-color: var(--warning);
        }
        
        .category-title {
            color: white;
            margin-bottom: 15px;
            font-size: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .material-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            font-size: 13px;
        }
        
        .material-item:last-child {
            border-bottom: none;
        }
        
        .material-name {
            color: #BDC3C7;
        }
        
        .material-qty {
            font-weight: 600;
            color: white;
        }
        
        .material-unit {
            color: #7F8C8D;
            font-size: 12px;
            margin-left: 4px;
        }
        
        .summary-section {
            background: linear-gradient(135deg, var(--secondary), var(--primary));
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .summary-item:last-child {
            border-bottom: none;
        }
        
        .summary-label {
            color: #BDC3C7;
            font-size: 13px;
        }
        
        .summary-value {
            font-weight: 700;
            color: white;
            font-size: 14px;
        }
        
        .safety-messages {
            background: rgba(192, 57, 43, 0.1);
            border-left: 4px solid var(--danger);
            padding: 15px;
            border-radius: 6px;
            margin-top: 20px;
        }
        
        .safety-title {
            color: var(--danger);
            font-weight: 600;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .safety-list {
            list-style: none;
            font-size: 13px;
            color: #BDC3C7;
        }
        
        .safety-list li {
            margin-bottom: 8px;
            padding-left: 20px;
            position: relative;
        }
        
        .safety-list li:before {
            content: '‚ö†Ô∏è';
            position: absolute;
            left: 0;
        }
        
        .dimension-display {
            background: rgba(44, 62, 80, 0.9);
            padding: 15px 25px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            border-left: 5px solid var(--accent);
        }
        
        .dimension-info {
            display: flex;
            gap: 20px;
        }
        
        .dimension-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .dimension-value {
            font-weight: 700;
            color: white;
        }
        
        .dimension-label {
            color: #BDC3C7;
            font-size: 13px;
        }
        
        .tooltip {
            position: relative;
            display: inline-block;
        }
        
        .tooltip-icon {
            width: 16px;
            height: 16px;
            background: rgba(255,255,255,0.1);
            color: #BDC3C7;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            cursor: help;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .tooltip-text {
            visibility: hidden;
            width: 250px;
            background: var(--dark);
            color: white;
            text-align: left;
            padding: 12px;
            border-radius: 6px;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
            font-weight: normal;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
        }
        
        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
    </style>
    <!-- Three.js from CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.min.js"></script>
    <!-- SheetJS for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <div class="app-container">
        <header class="header">
            <h1>üèóÔ∏è OIL & GAS SCAFFOLDING CALCULATOR</h1>
            <p class="subtitle">HSE-Compliant Scaffold Design & 3D Planning Tool | Refinery ‚Ä¢ Offshore ‚Ä¢ Plant Maintenance</p>
        </header>
        
        <div class="compliance-banner">
            <span>‚ö°</span>
            <span>STRICT SAFETY COMPLIANCE: All designs follow OSHA/EN 12811 standards. Unsafe configurations are automatically rejected.</span>
        </div>
        
        <div class="dimension-display">
            <div class="dimension-info">
                <div class="dimension-item">
                    <span class="dimension-label">Length:</span>
                    <span class="dimension-value" id="disp-length">10 m</span>
                </div>
                <div class="dimension-item">
                    <span class="dimension-label">Width:</span>
                    <span class="dimension-value" id="disp-width">6 m</span>
                </div>
                <div class="dimension-item">
                    <span class="dimension-label">Height:</span>
                    <span class="dimension-value" id="disp-height">5 m</span>
                </div>
                <div class="dimension-item">
                    <span class="dimension-label">Load Class:</span>
                    <span class="dimension-value" id="disp-load">Medium</span>
                </div>
            </div>
            <div id="compliance-status" class="compliance-status status-warning">
                ‚ö†Ô∏è VALIDATING...
            </div>
        </div>
        
        <div class="main-content">
            <div class="control-panel">
                <div class="section">
                    <div class="section-title">üìê GEOMETRY & STRUCTURE</div>
                    <div class="input-row">
                        <div class="input-group">
                            <label>Length (m)</label>
                            <input type="number" id="length" value="10" min="2" max="100" step="0.5">
                        </div>
                        <div class="input-group">
                            <label>Width (m)</label>
                            <input type="number" id="width" value="6" min="2" max="100" step="0.5">
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label>Height (m)</label>
                            <input type="number" id="height" value="5" min="1" max="50" step="0.5">
                        </div>
                        <div class="input-group">
                            <label>Working Levels</label>
                            <select id="working-levels">
                                <option value="1">Single Level</option>
                                <option value="2">Two Levels</option>
                                <option value="3" selected>Three Levels</option>
                                <option value="4">Four Levels</option>
                                <option value="5">Five Levels</option>
                            </select>
                        </div>
                    </div>
                    <div class="checkbox-grid">
                        <div class="checkbox-item">
                            <input type="checkbox" id="uneven-ground">
                            <label for="uneven-ground">Uneven Ground</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="adjacent-structure">
                            <label for="adjacent-structure">Adjacent to Structure</label>
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <div class="section-title">üîß SYSTEM CONFIGURATION</div>
                    <div class="input-group">
                        <label>Scaffolding System</label>
                        <select id="system-type">
                            <option value="cup_lock">Cup Lock System</option>
                            <option value="ring_lock" selected>Ring Lock System</option>
                            <option value="tube_coupler">Tube & Coupler</option>
                            <option value="hanging">Hanging Scaffold</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Load Classification</label>
                            <select id="load-class">
                            <option value="light">Light Duty (125 kg/m¬≤)</option>
                            <option value="medium" selected>Medium Duty (250 kg/m¬≤)</option>
                            <option value="heavy">Heavy Duty (500 kg/m¬≤)</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Safety Standard</label>
                        <select id="safety-standard">
                            <option value="osha">OSHA 1926.451</option>
                            <option value="en12811" selected>EN 12811</option>
                            <option value="bs5973">BS 5973</option>
                            <option value="site">Site Specific Rules</option>
                        </select>
                    </div>
                </div>
                
                <div class="section">
                    <div class="section-title">üõ°Ô∏è SAFETY FEATURES</div>
                    <div class="checkbox-grid">
                        <div class="checkbox-item">
                            <input type="checkbox" id="guardrail" checked>
                            <label for="guardrail">Guardrail (Top/Mid)</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="toe-boards" checked>
                            <label for="toe-boards">Toe Boards</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="safety-net">
                            <label for="safety-net">Safety Net</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="debris-net">
                            <label for="debris-net">Debris Net</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="ladder" checked>
                            <label for="ladder">Access Ladder</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="platform-boards" checked>
                            <label for="platform-boards">Platform Boards</label>
                        </div>
                    </div>
                </div>
                
                <div class="section danger-zone">
                    <div class="section-title">‚ö†Ô∏è CRITICAL SAFETY CHECKS</div>
                    <div style="font-size: 12px; color: #BDC3C7; line-height: 1.5;">
                        <p>System automatically enforces:</p>
                        <ul style="margin: 10px 0 10px 20px;">
                            <li>Height-to-base ratio ‚â§ 4:1</li>
                            <li>Guardrail required above 2.0m</li>
                            <li>Double ledger for Heavy Duty</li>
                            <li>Tie requirements based on height</li>
                        </ul>
                        <p style="color: var(--danger); font-weight: 600;">
                            ‚ùå Unsafe designs will be rejected
                        </p>
                    </div>
                </div>
                
                <button class="btn-primary" id="calculate-btn" onclick="calculateScaffolding()">
                    <span>üöÄ CALCULATE & VALIDATE SCAFFOLD</span>
                </button>
            </div>
            
            <div class="visualization-panel">
                <div class="visualization-header">
                    <h2>üé® 3D ENGINEERING VIEW</h2>
                    <div class="view-controls">
                        <button class="view-btn active" onclick="toggleView('all')">All</button>
                        <button class="view-btn" onclick="toggleView('structure')">Structure</button>
                        <button class="view-btn" onclick="toggleView('platform')">Platform</button>
                        <button class="view-btn" onclick="toggleView('safety')">Safety</button>
                    </div>
                </div>
                <div id="canvas-container">
                    <canvas id="canvas-3d"></canvas>
                    <div class="canvas-info">
                        üñ±Ô∏è Drag: Rotate | üîç Scroll: Zoom | üì± Right Drag: Pan
                    </div>
                    <div class="legend">
                        <div class="legend-item">
                            <div class="legend-color" style="background: #27AE60;"></div>
                            <span>Standards</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #3498DB;"></div>
                            <span>Ledgers</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #E74C3C;"></div>
                            <span>Bracing</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #8E44AD;"></div>
                            <span>Platform</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #F39C12;"></div>
                            <span>Safety</span>
                        </div>
                    </div>
                    <div class="loading-overlay" id="loading-overlay" style="display: none;">
                        <div class="loading-spinner"></div>
                        <p>Running Safety Checks...</p>
                        <p style="font-size: 12px; color: #BDC3C7; margin-top: 10px;">Validating HSE Compliance</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="results-panel">
            <div class="results-header">
                <h2>üìä ENGINEERING OUTPUT</h2>
                <div class="export-dropdown">
                    <button class="btn-primary export-btn" onclick="toggleExportMenu()">
                        üì• EXPORT REPORTS
                    </button>
                    <div class="export-menu" id="export-menu">
                        <button class="export-option" onclick="exportToCSV()">
                            üìÑ Export as CSV
                        </button>
                        <button class="export-option" onclick="exportToExcel()">
                            üìä Export as Excel (XLSX)
                        </button>
                        <button class="export-option" onclick="exportToPDF()">
                            üìë Export as PDF
                        </button>
                        <button class="export-option" onclick="exportMaterialList()">
                            üìã Material List Only
                        </button>
                        <button class="export-option" onclick="exportSafetyReport()">
                            üõ°Ô∏è Safety Report
                        </button>
                        <button class="export-option" onclick="exportAllReports()">
                            üóÇÔ∏è All Reports (ZIP)
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="results-tabs">
                <button class="tab-btn active" onclick="switchTab('materials')">Materials BOQ</button>
                <button class="tab-btn" onclick="switchTab('engineering')">Engineering Summary</button>
                <button class="tab-btn" onclick="switchTab('construction')">Construction Data</button>
                <button class="tab-btn" onclick="switchTab('safety')">Safety Notes</button>
            </div>
            
            <div id="materials-tab" class="tab-content active">
                <div class="materials-grid">
                    <div class="material-category">
                        <div class="category-title">üìè MAIN STRUCTURE</div>
                        <div class="material-item">
                            <span class="material-name">Vertical Standards (3m)</span>
                            <span class="material-qty">-- <span class="material-unit">batang</span></span>
                        </div>
                        <div class="material-item">
                            <span class="material-name">Horizontal Ledgers (3m)</span>
                            <span class="material-qty">-- <span class="material-unit">batang</span></span>
                        </div>
                        <div class="material-item">
                            <span class="material-name">Diagonal Braces (3m)</span>
                            <span class="material-qty">-- <span class="material-unit">batang</span></span>
                        </div>
                        <div class="material-item">
                            <span class="material-name">Transoms (2m)</span>
                            <span class="material-qty">-- <span class="material-unit">batang</span></span>
                        </div>
                    </div>
                    
                    <div class="material-category platform">
                        <div class="category-title">üèóÔ∏è PLATFORM & ACCESS</div>
                        <div class="material-item">
                            <span class="material-name">Steel Planks (3m)</span>
                            <span class="material-qty">-- <span class="material-unit">pcs</span></span>
                        </div>
                        <div class="material-item">
                            <span class="material-name">Aluminum Deck</span>
                            <span class="material-qty">-- <span class="material-unit">m¬≤</span></span>
                        </div>
                        <div class="material-item">
                            <span class="material-name">Access Ladder</span>
                            <span class="material-qty">-- <span class="material-unit">set</span></span>
                        </div>
                        <div class="material-item">
                            <span class="material-name">Trapdoor Platform</span>
                            <span class="material-qty">-- <span class="material-unit">pcs</span></span>
                        </div>
                    </div>
                    
                    <div class="material-category safety">
                        <div class="category-title">üõ°Ô∏è SAFETY EQUIPMENT</div>
                        <div class="material-item">
                            <span class="material-name">Guardrail System</span>
                            <span class="material-qty">-- <span class="material-unit">m</span></span>
                        </div>
                        <div class="material-item">
                            <span class="material-name">Toe Boards</span>
                            <span class="material-qty">-- <span class="material-unit">m</span></span>
                        </div>
                        <div class="material-item">
                            <span class="material-name">Safety Net</span>
                            <span class="material-qty">-- <span class="material-unit">m¬≤</span></span>
                        </div>
                        <div class="material-item">
                            <span class="material-name">Debris Net</span>
                            <span class="material-qty">-- <span class="material-unit">m¬≤</span></span>
                        </div>
                    </div>
                    
                    <div class="material-category accessories">
                        <div class="category-title">üîó CONNECTORS & ACCESSORIES</div>
                        <div class="material-item">
                            <span class="material-name">Base Plates</span>
                            <span class="material-qty">-- <span class="material-unit">pcs</span></span>
                        </div>
                        <div class="material-item">
                            <span class="material-name">Adjustable Jacks</span>
                            <span class="material-qty">-- <span class="material-unit">pcs</span></span>
                        </div>
                        <div class="material-item">
                            <span class="material-name">Wall Ties</span>
                            <span class="material-qty">-- <span class="material-unit">pcs</span></span>
                        </div>
                        <div class="material-item">
                            <span class="material-name">Anchor Bolts</span>
                            <span class="material-qty">-- <span class="material-unit">pcs</span></span>
                        </div>
                    </div>
                </div>
                
                <div class="summary-section">
                    <div class="summary-item">
                        <span class="summary-label">Total Tube Required (3m)</span>
                        <span class="summary-value">-- batang</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Total Estimated Weight</span>
                        <span class="summary-value">-- kg</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Projected Area</span>
                        <span class="summary-value">-- m¬≤</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Material Wastage (5%)</span>
                        <span class="summary-value">-- batang</span>
                    </div>
                </div>
            </div>
            
            <div id="engineering-tab" class="tab-content">
                <div class="materials-grid">
                    <div class="material-category">
                        <div class="category-title">üìê STRUCTURAL DATA</div>
                        <div class="material-item">
                            <span class="material-name">Standard Spacing</span>
                            <span class="material-qty">-- m</span>
                        </div>
                        <div class="material-item">
                            <span class="material-name">Ledger Spacing</span>
                            <span class="material-qty">-- m</span>
                        </div>
                        <div class="material-item">
                            <span class="material-name">Lift Height</span>
                            <span class="material-qty">-- m</span>
                        </div>
                        <div class="material-item">
                            <span class="material-name">Number of Lifts</span>
                            <span class="material-qty">--</span>
                        </div>
                    </div>
                    
                    <div class="material-category">
                        <div class="category-title">‚öì TIE & ANCHOR SYSTEM</div>
                        <div class="material-item">
                            <span class="material-name">Horizontal Tie Spacing</span>
                            <span class="material-qty">-- m</span>
                        </div>
                        <div class="material-item">
                            <span class="material-name">Vertical Tie Spacing</span>
                            <span class="material-qty">-- m</span>
                        </div>
                        <div class="material-item">
                            <span class="material-name">Total Wall Ties</span>
                            <span class="material-qty">-- pcs</span>
                        </div>
                        <div class="material-item">
                            <span class="material-name">Anchor Bolt Type</span>
                            <span class="material-qty">--</span>
                        </div>
                    </div>
                    
                    <div class="material-category danger-zone">
                        <div class="category-title">‚ö†Ô∏è SAFETY CHECKS</div>
                        <div class="material-item">
                            <span class="material-name">Height-to-Base Ratio</span>
                            <span class="material-qty" id="ratio-check">--</span>
                        </div>
                        <div class="material-item">
                            <span class="material-name">Guardrail Compliance</span>
                            <span class="material-qty" id="guardrail-check">--</span>
                        </div>
                        <div class="material-item">
                            <span class="material-name">Double Ledger Check</span>
                            <span class="material-qty" id="ledger-check">--</span>
                        </div>
                        <div class="material-item">
                            <span class="material-name">Tie Requirement</span>
                            <span class="material-qty" id="tie-check">--</span>
                        </div>
                    </div>
                </div>
                
                <div class="safety-messages">
                    <div class="safety-title">üî¥ CRITICAL SAFETY NOTES</div>
                    <ul class="safety-list" id="safety-notes">
                        <li>Anchor capacity must be verified against concrete strength</li>
                        <li>All connections must be torqued to specification</li>
                        <li>Daily inspection required before use</li>
                    </ul>
                </div>
            </div>
            
            <div id="construction-tab" class="tab-content">
                <div class="materials-grid">
                    <div class="material-category">
                        <div class="category-title">üë∑ ERECTION DATA</div>
                        <div class="material-item">
                            <span class="material-name">Erection Man-Hours</span>
                            <span class="material-qty">-- hours</span>
                        </div>
                        <div class="material-item">
                            <span class="material-name">Crew Size Required</span>
                            <span class="material-qty">-- persons</span>
                        </div>
                        <div class="material-item">
                            <span class="material-name">Erection Duration</span>
                            <span class="material-qty">-- days</span>
                        </div>
                        <div class="material-item">
                            <span class="material-name">Scaffolder Level</span>
                            <span class="material-qty">Advanced</span>
                        </div>
                    </div>
                    
                    <div class="material-category">
                        <div class="category-title">üì¶ LOGISTICS</div>
                        <div class="material-item">
                            <span class="material-name">Total Weight</span>
                            <span class="material-qty">-- kg</span>
                        </div>
                        <div class="material-item">
                            <span class="material-name">Volume Required</span>
                            <span class="material-qty">-- m¬≥</span>
                        </div>
                        <div class="material-item">
                            <span class="material-name">Truck Loads</span>
                            <span class="material-qty">-- loads</span>
                        </div>
                        <div class="material-item">
                            <span class="material-name">Crane Required</span>
                            <span class="material-qty">Yes/No</span>
                        </div>
                    </div>
                    
                    <div class="material-category">
                        <div class="category-title">üîß DISMANTLING</div>
                        <div class="material-item">
                            <span class="material-name">Dismantling Man-Hours</span>
                            <span class="material-qty">-- hours</span>
                        </div>
                        <div class="material-item">
                            <span class="material-name">Waste Disposal</span>
                            <span class="material-qty">-- m¬≥</span>
                        </div>
                        <div class="material-item">
                            <span class="material-name">Cleaning Required</span>
                            <span class="material-qty">-- hours</span>
                        </div>
                        <div class="material-item">
                            <span class="material-name">Inspection Post-Dismantle</span>
                            <span class="material-qty">Required</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="safety-tab" class="tab-content">
                <div class="safety-messages">
                    <div class="safety-title">üõë HSE COMPLIANCE REQUIREMENTS</div>
                    <ul class="safety-list">
                        <li>Scaffold Tag System must be implemented (Green/Yellow/Red)</li>
                        <li>Daily inspection by competent person before each shift</li>
                        <li>Maximum permissible load must not be exceeded</li>
                        <li>All personnel must complete scaffold safety training</li>
                        <li>Weather conditions must be monitored (wind > 50 km/h requires shutdown)</li>
                        <li>Fall protection required for erection/dismantling above 2m</li>
                        <li>Tools and materials must be secured to prevent falling objects</li>
                        <li>Emergency rescue plan must be established and communicated</li>
                    </ul>
                </div>
                
                <div class="safety-messages" style="margin-top: 20px; background: rgba(243, 156, 18, 0.1); border-left-color: var(--warning);">
                    <div class="safety-title">üìù DOCUMENTATION REQUIREMENTS</div>
                    <ul class="safety-list">
                        <li>Scaffold Design Certificate (Engineer stamped)</li>
                        <li>Material Inspection Reports</li>
                        <li>Erection Competency Certificates</li>
                        <li>Daily Inspection Checklists</li>
                        <li>Load Test Certificate (if required)</li>
                        <li>Handover Certificate to user department</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let scene, camera, renderer, controls;
        let scaffoldingGroup;
        let is3DInitialized = false;
        let currentView = 'all';
        let currentCalculationData = null;

        // Initialize 3D Scene
        function init3D() {
            try {
                const canvas = document.getElementById('canvas-3d');
                const container = document.getElementById('canvas-container');
                
                // Create scene
                scene = new THREE.Scene();
                scene.background = new THREE.Color(0x1A252F);
                scene.fog = new THREE.Fog(0x1A252F, 10, 100);
                
                // Create camera
                camera = new THREE.PerspectiveCamera(
                    60,
                    container.clientWidth / container.clientHeight,
                    0.1,
                    1000
                );
                camera.position.set(25, 20, 25);
                
                // Create renderer
                renderer = new THREE.WebGLRenderer({
                    canvas: canvas,
                    antialias: true,
                    alpha: true
                });
                renderer.setSize(container.clientWidth, container.clientHeight);
                renderer.setPixelRatio(window.devicePixelRatio);
                renderer.shadowMap.enabled = true;
                renderer.shadowMap.type = THREE.PCFSoftShadowMap;
                
                // Add OrbitControls
                controls = new THREE.OrbitControls(camera, renderer.domElement);
                controls.enableDamping = true;
                controls.dampingFactor = 0.05;
                controls.minDistance = 5;
                controls.maxDistance = 150;
                controls.maxPolarAngle = Math.PI * 0.8;
                
                // Lighting
                const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
                scene.add(ambientLight);
                
                const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
                directionalLight.position.set(50, 100, 50);
                directionalLight.castShadow = true;
                directionalLight.shadow.mapSize.width = 2048;
                directionalLight.shadow.mapSize.height = 2048;
                scene.add(directionalLight);
                
                // Ground plane
                const groundGeometry = new THREE.PlaneGeometry(200, 200);
                const groundMaterial = new THREE.MeshLambertMaterial({ 
                    color: 0x2C3E50,
                    roughness: 0.9
                });
                const ground = new THREE.Mesh(groundGeometry, groundMaterial);
                ground.rotation.x = -Math.PI / 2;
                ground.receiveShadow = true;
                scene.add(ground);
                
                // Grid helper
                const gridHelper = new THREE.GridHelper(200, 50, 0x34495E, 0x2C3E50);
                gridHelper.position.y = 0.01;
                scene.add(gridHelper);
                
                // Scaffolding group
                scaffoldingGroup = new THREE.Group();
                scene.add(scaffoldingGroup);
                
                // Resize handler
                window.addEventListener('resize', onWindowResize);
                
                // Animation loop
                animate();
                
                is3DInitialized = true;
                updateComplianceStatus('3D Engine Ready', 'warning');
                
            } catch (error) {
                console.error('3D Initialization failed:', error);
                updateComplianceStatus('3D Engine Failed', 'danger');
                alert('3D graphics initialization failed. Please refresh the page.');
            }
        }

        // Safety validation function
        function validateSafety(length, width, height, loadClass, features) {
            const violations = [];
            const warnings = [];
            
            // Height-to-base ratio check
            const baseMin = Math.min(length, width);
            const heightRatio = height / baseMin;
            if (heightRatio > 4) {
                violations.push(`Height-to-base ratio ${heightRatio.toFixed(1)}:1 exceeds 4:1 limit. Ties to structure required.`);
            } else if (heightRatio > 3) {
                warnings.push(`Height-to-base ratio ${heightRatio.toFixed(1)}:1. Additional bracing recommended.`);
            }
            
            // Guardrail requirement
            if (height > 2.0 && !features.guardrail) {
                violations.push('Guardrail system required for heights above 2.0m');
            }
            
            // Toe board requirement
            if (height > 1.2 && !features.toeBoards) {
                violations.push('Toe boards required for platform heights above 1.2m');
            }
            
            // Double ledger for heavy duty
            if (loadClass === 'heavy' && !features.doubleLedger) {
                violations.push('Double ledger system required for Heavy Duty classification');
            }
            
            // Hanging scaffold safety
            const systemType = document.getElementById('system-type').value;
            if (systemType === 'hanging' && !features.secondarySupport) {
                violations.push('Secondary support system required for hanging scaffolds');
            }
            
            // Working level safety
            const workingLevels = parseInt(document.getElementById('working-levels').value);
            if (workingLevels > 3 && !features.extraBracing) {
                warnings.push('Extra diagonal bracing recommended for scaffolds with more than 3 working levels');
            }
            
            return { violations, warnings, heightRatio, isCompliant: violations.length === 0 };
        }

        // Calculate materials with engineering logic
        function calculateMaterials(length, width, height, systemType, loadClass, features, workingLevels) {
            // Engineering parameters based on load class
            const params = {
                light: { 
                    standardSpacing: 2.4, 
                    ledgerSpacing: 2.0,
                    transomSpacing: 1.2,
                    bracingInterval: 3,
                    doubleLedger: false
                },
                medium: { 
                    standardSpacing: 2.0, 
                    ledgerSpacing: 1.8,
                    transomSpacing: 1.0,
                    bracingInterval: 2,
                    doubleLedger: false
                },
                heavy: { 
                    standardSpacing: 1.5, 
                    ledgerSpacing: 1.5,
                    transomSpacing: 0.75,
                    bracingInterval: 1,
                    doubleLedger: true
                }
            };
            
            const p = params[loadClass];
            
            // Calculate grid
            const barsX = Math.max(2, Math.ceil(length / p.standardSpacing) + 1);
            const barsZ = Math.max(2, Math.ceil(width / p.standardSpacing) + 1);
            const lifts = Math.ceil(height / p.ledgerSpacing);
            
            // Calculate structural tubes (in meters)
            let verticalTube = barsX * barsZ * height * 1.05; // 5% wastage
            
            // Horizontal ledgers
            let horizontalTube = (barsZ * length * lifts) + (barsX * width * lifts);
            if (p.doubleLedger) horizontalTube *= 2;
            
            // Transoms
            const transomsPerLevel = Math.ceil(length / p.transomSpacing) * barsZ;
            let transomTube = transomsPerLevel * lifts * 2.0; // 2m transoms
            
            // Diagonal bracing
            const bracingSets = Math.max(1, Math.ceil(length / p.bracingInterval) * Math.ceil(width / p.bracingInterval));
            let diagonalTube = bracingSets * lifts * Math.sqrt(length*length + width*width) * 0.5;
            
            // Tie system calculation
            const tieHorizontalSpacing = Math.min(6.0, length / 2);
            const tieVerticalSpacing = Math.min(4.0, height / 3);
            const wallTies = Math.max(2, Math.ceil(length / tieHorizontalSpacing) * Math.ceil(height / tieVerticalSpacing));
            
            // Safety equipment
            const guardrailLength = features.guardrail ? (length + width) * 2 * lifts * 2 : 0; // Top + mid rail
            const toeBoardLength = features.toeBoards ? (length + width) * 2 * lifts : 0;
            const safetyNetArea = features.safetyNet ? length * width * 1.1 : 0; // 10% overhang
            const debrisNetArea = features.debrisNet ? (length + height * 2) * (width + height * 2) : 0;
            
            // Platform materials
            const platformArea = length * width * workingLevels;
            const steelPlanks = Math.ceil(platformArea / (0.3 * 3)); // 300mm wide, 3m long
            const aluminumDeck = features.platformBoards ? platformArea : 0;
            
            // Access ladder
            const ladderSets = features.ladder ? Math.ceil(length / 10) : 0; // One per 10m length
            
            // Base plates and jacks
            const basePlates = barsX * barsZ;
            const adjustableJacks = document.getElementById('uneven-ground').checked ? basePlates : Math.ceil(basePlates * 0.3);
            
            // Anchor bolts
            const anchorBolts = wallTies * 2; // Two bolts per tie
            
            // Calculate totals
            const totalTubeMeters = verticalTube + horizontalTube + transomTube + diagonalTube;
            const totalTubePieces = Math.ceil(totalTubeMeters / 3);
            const estimatedWeight = Math.round(totalTubeMeters * 4.0); // ~4kg per meter
            
            // Erection data
            const erectionHours = Math.round(totalTubePieces * 0.25 + platformArea * 0.1 + wallTies * 0.5);
            const dismantlingHours = Math.round(erectionHours * 0.7);
            
            return {
                barsX, barsZ, lifts,
                verticalTube: Math.ceil(verticalTube / 3),
                horizontalTube: Math.ceil(horizontalTube / 3),
                transomTube: Math.ceil(transomTube / 2), // 2m pieces
                diagonalTube: Math.ceil(diagonalTube / 3),
                totalTube: totalTubePieces,
                totalTubeMeters,
                guardrailLength: Math.ceil(guardrailLength),
                toeBoardLength: Math.ceil(toeBoardLength),
                safetyNetArea: Math.ceil(safetyNetArea),
                debrisNetArea: Math.ceil(debrisNetArea),
                steelPlanks,
                aluminumDeck: Math.ceil(aluminumDeck),
                ladderSets,
                basePlates,
                adjustableJacks,
                wallTies,
                anchorBolts,
                tieHorizontalSpacing,
                tieVerticalSpacing,
                estimatedWeight,
                platformArea: Math.round(platformArea),
                erectionHours,
                dismantlingHours,
                standardSpacing: p.standardSpacing,
                ledgerSpacing: p.ledgerSpacing,
                transomSpacing: p.transomSpacing,
                bracingInterval: p.bracingInterval,
                doubleLedger: p.doubleLedger
            };
        }

        // Draw 3D scaffolding with engineering accuracy
        function drawScaffolding3D(length, width, height, systemType, loadClass, features, results) {
            if (!is3DInitialized) return;
            
            // Clear previous scaffolding
            while(scaffoldingGroup.children.length > 0) {
                scaffoldingGroup.remove(scaffoldingGroup.children[0]);
            }
            
            const params = {
                light: { standardSpacing: 2.4, ledgerSpacing: 2.0 },
                medium: { standardSpacing: 2.0, ledgerSpacing: 1.8 },
                heavy: { standardSpacing: 1.5, ledgerSpacing: 1.5 }
            };
            
            const p = params[loadClass];
            const barsX = results.barsX;
            const barsZ = results.barsZ;
            const lifts = results.lifts;
            
            // Calculate actual dimensions based on spacing
            const actualLength = (barsX - 1) * p.standardSpacing;
            const actualWidth = (barsZ - 1) * p.standardSpacing;
            
            // Materials with color coding
            const materials = {
                standard: new THREE.MeshPhongMaterial({ 
                    color: 0x27AE60,
                    shininess: 20,
                    specular: 0x111111
                }),
                ledger: new THREE.MeshPhongMaterial({ 
                    color: 0x3498DB,
                    shininess: 20,
                    specular: 0x111111
                }),
                bracing: new THREE.MeshPhongMaterial({ 
                    color: 0xE74C3C,
                    shininess: 20,
                    specular: 0x111111
                }),
                platform: new THREE.MeshPhongMaterial({ 
                    color: 0x8E44AD,
                    transparent: true,
                    opacity: 0.7,
                    side: THREE.DoubleSide
                }),
                safety: new THREE.MeshPhongMaterial({ 
                    color: 0xF39C12,
                    shininess: 40,
                    specular: 0x333333
                }),
                base: new THREE.MeshPhongMaterial({ 
                    color: 0x7D6608,
                    roughness: 0.9,
                    metalness: 0.3
                })
            };
            
            // Tube geometry
            const tubeRadius = 0.06;
            const tubeGeometry = new THREE.CylinderGeometry(tubeRadius, tubeRadius, 1, 8);
            
            // Draw vertical standards
            for (let x = 0; x < barsX; x++) {
                for (let z = 0; z < barsZ; z++) {
                    const posX = (x * p.standardSpacing) - (actualLength / 2);
                    const posZ = (z * p.standardSpacing) - (actualWidth / 2);
                    
                    // Main vertical tube
                    const tube = new THREE.Mesh(tubeGeometry, materials.standard);
                    tube.scale.set(1, height, 1);
                    tube.position.set(posX, height / 2, posZ);
                    tube.castShadow = true;
                    tube.receiveShadow = true;
                    tube.userData = { type: 'standard', visible: true };
                    scaffoldingGroup.add(tube);
                    
                    // Base plate
                    const baseGeometry = new THREE.CylinderGeometry(0.15, 0.15, 0.05, 6);
                    const basePlate = new THREE.Mesh(baseGeometry, materials.base);
                    basePlate.position.set(posX, 0.025, posZ);
                    basePlate.castShadow = true;
                    basePlate.userData = { type: 'base', visible: true };
                    scaffoldingGroup.add(basePlate);
                }
            }
            
            // Draw horizontal ledgers
            for (let y = 1; y <= lifts; y++) {
                const posY = y * p.ledgerSpacing;
                
                // Ledgers along X-axis (front to back)
                for (let z = 0; z < barsZ; z++) {
                    const posZ = (z * p.standardSpacing) - (actualWidth / 2);
                    
                    const ledger = new THREE.Mesh(tubeGeometry, materials.ledger);
                    ledger.scale.set(actualLength, 1, 1);
                    ledger.rotation.z = Math.PI / 2;
                    ledger.position.set(0, posY, posZ);
                    ledger.castShadow = true;
                    ledger.receiveShadow = true;
                    ledger.userData = { type: 'ledger', visible: true };
                    scaffoldingGroup.add(ledger);
                }
                
                // Ledgers along Z-axis (left to right)
                for (let x = 0; x < barsX; x++) {
                    const posX = (x * p.standardSpacing) - (actualLength / 2);
                    
                    const ledger = new THREE.Mesh(tubeGeometry, materials.ledger);
                    ledger.scale.set(actualWidth, 1, 1);
                    ledger.rotation.z = Math.PI / 2;
                    ledger.rotation.y = Math.PI / 2;
                    ledger.position.set(posX, posY, 0);
                    ledger.castShadow = true;
                    ledger.receiveShadow = true;
                    ledger.userData = { type: 'ledger', visible: true };
                    scaffoldingGroup.add(ledger);
                }
                
                // Draw platform at working levels
                const workingLevels = parseInt(document.getElementById('working-levels').value);
                const isWorkingLevel = y <= workingLevels;
                
                if (isWorkingLevel && features.platformBoards) {
                    const platformGeometry = new THREE.PlaneGeometry(actualLength - 0.3, actualWidth - 0.3);
                    const platform = new THREE.Mesh(platformGeometry, materials.platform);
                    platform.rotation.x = -Math.PI / 2;
                    platform.position.set(0, posY + 0.05, 0);
                    platform.receiveShadow = true;
                    platform.userData = { type: 'platform', visible: true };
                    scaffoldingGroup.add(platform);
                }
                
                // Draw safety features at top level
                if (features.guardrail && y === lifts) {
                    const railingHeight = posY + 1.0;
                    
                    // Top rail - all four sides
                    const topRailFront = new THREE.Mesh(tubeGeometry, materials.safety);
                    topRailFront.scale.set(actualLength, 1, 1);
                    topRailFront.rotation.z = Math.PI / 2;
                    topRailFront.position.set(0, railingHeight, -actualWidth/2);
                    topRailFront.castShadow = true;
                    topRailFront.userData = { type: 'safety', visible: true };
                    scaffoldingGroup.add(topRailFront);
                    
                    const topRailBack = new THREE.Mesh(tubeGeometry, materials.safety);
                    topRailBack.scale.set(actualLength, 1, 1);
                    topRailBack.rotation.z = Math.PI / 2;
                    topRailBack.position.set(0, railingHeight, actualWidth/2);
                    topRailBack.castShadow = true;
                    topRailBack.userData = { type: 'safety', visible: true };
                    scaffoldingGroup.add(topRailBack);
                    
                    const topRailLeft = new THREE.Mesh(tubeGeometry, materials.safety);
                    topRailLeft.scale.set(actualWidth, 1, 1);
                    topRailLeft.rotation.z = Math.PI / 2;
                    topRailLeft.rotation.y = Math.PI / 2;
                    topRailLeft.position.set(-actualLength/2, railingHeight, 0);
                    topRailLeft.castShadow = true;
                    topRailLeft.userData = { type: 'safety', visible: true };
                    scaffoldingGroup.add(topRailLeft);
                    
                    const topRailRight = new THREE.Mesh(tubeGeometry, materials.safety);
                    topRailRight.scale.set(actualWidth, 1, 1);
                    topRailRight.rotation.z = Math.PI / 2;
                    topRailRight.rotation.y = Math.PI / 2;
                    topRailRight.position.set(actualLength/2, railingHeight, 0);
                    topRailRight.castShadow = true;
                    topRailRight.userData = { type: 'safety', visible: true };
                    scaffoldingGroup.add(topRailRight);
                    
                    // Mid rail at 0.5m below top rail
                    const midRailHeight = posY + 0.5;
                    
                    const midRailFront = new THREE.Mesh(tubeGeometry, materials.safety);
                    midRailFront.scale.set(actualLength, 1, 1);
                    midRailFront.rotation.z = Math.PI / 2;
                    midRailFront.position.set(0, midRailHeight, -actualWidth/2);
                    midRailFront.castShadow = true;
                    midRailFront.userData = { type: 'safety', visible: true };
                    scaffoldingGroup.add(midRailFront);
                    
                    const midRailBack = new THREE.Mesh(tubeGeometry, materials.safety);
                    midRailBack.scale.set(actualLength, 1, 1);
                    midRailBack.rotation.z = Math.PI / 2;
                    midRailBack.position.set(0, midRailHeight, actualWidth/2);
                    midRailBack.castShadow = true;
                    midRailBack.userData = { type: 'safety', visible: true };
                    scaffoldingGroup.add(midRailBack);
                }
            }
            
            // Draw diagonal bracing
            if (barsX > 1 && barsZ > 1 && lifts > 0) {
                // Add diagonal braces on two opposite faces
                const braceHeight = p.ledgerSpacing;
                
                // Front face diagonal
                const frontBraceLength = Math.sqrt(actualLength * actualLength + braceHeight * braceHeight);
                const frontBraceAngle = Math.atan2(braceHeight, actualLength);
                
                const frontBrace = new THREE.Mesh(tubeGeometry, materials.bracing);
                frontBrace.scale.set(frontBraceLength, 1, 1);
                frontBrace.rotation.z = Math.PI / 2;
                frontBrace.rotation.y = -frontBraceAngle;
                frontBrace.position.set(0, braceHeight/2, -actualWidth/2);
                frontBrace.castShadow = true;
                frontBrace.userData = { type: 'bracing', visible: true };
                scaffoldingGroup.add(frontBrace);
                
                // Back face diagonal (opposite direction)
                const backBrace = new THREE.Mesh(tubeGeometry, materials.bracing);
                backBrace.scale.set(frontBraceLength, 1, 1);
                backBrace.rotation.z = Math.PI / 2;
                backBrace.rotation.y = frontBraceAngle;
                backBrace.position.set(0, braceHeight/2, actualWidth/2);
                backBrace.castShadow = true;
                backBrace.userData = { type: 'bracing', visible: true };
                scaffoldingGroup.add(backBrace);
            }
            
            // Update camera position to frame the structure properly
            const centerY = height / 2;
            const maxDimension = Math.max(actualLength, actualWidth, height);
            const distance = maxDimension * 1.5;
            
            camera.position.set(distance, distance * 0.7, distance);
            controls.target.set(0, centerY, 0);
            controls.update();
            
            // Update visibility based on current view
            updateViewVisibility();
            
            updateComplianceStatus('3D Model Generated', 'warning');
        }

        // Update view visibility
        function updateViewVisibility() {
            scaffoldingGroup.children.forEach(child => {
                if (child.userData && child.userData.type) {
                    let visible = false;
                    switch(currentView) {
                        case 'all':
                            visible = true;
                            break;
                        case 'structure':
                            visible = ['standard', 'ledger', 'bracing', 'base'].includes(child.userData.type);
                            break;
                        case 'platform':
                            visible = ['platform', 'standard'].includes(child.userData.type);
                            break;
                        case 'safety':
                            visible = ['safety', 'standard'].includes(child.userData.type);
                            break;
                    }
                    child.visible = visible;
                }
            });
        }

        // Toggle view
        function toggleView(view) {
            currentView = view;
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.toLowerCase().includes(view)) {
                    btn.classList.add('active');
                }
            });
            updateViewVisibility();
        }

        // Switch tabs
        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
        }

        // Update compliance status
        function updateComplianceStatus(message, status) {
            const element = document.getElementById('compliance-status');
            element.textContent = message;
            element.className = `compliance-status status-${status}`;
        }

        // Display results
        function displayResults(results, safetyCheck) {
            // Store calculation data for export
            currentCalculationData = {
                results,
                safetyCheck,
                timestamp: new Date().toISOString(),
                project: 'Scaffolding Design - Oil & Gas',
                dimensions: {
                    length: parseFloat(document.getElementById('length').value),
                    width: parseFloat(document.getElementById('width').value),
                    height: parseFloat(document.getElementById('height').value)
                },
                system: document.getElementById('system-type').options[document.getElementById('system-type').selectedIndex].text,
                loadClass: document.getElementById('load-class').options[document.getElementById('load-class').selectedIndex].text,
                safetyStandard: document.getElementById('safety-standard').options[document.getElementById('safety-standard').selectedIndex].text,
                workingLevels: parseInt(document.getElementById('working-levels').value)
            };
            
            // Materials BOQ
            const materialQtys = document.querySelectorAll('.material-qty');
            if (materialQtys.length >= 15) {
                materialQtys[0].textContent = results.verticalTube + ' ';
                materialQtys[1].textContent = results.horizontalTube + ' ';
                materialQtys[2].textContent = results.diagonalTube + ' ';
                materialQtys[3].textContent = results.transomTube + ' ';
                materialQtys[4].textContent = results.steelPlanks + ' ';
                materialQtys[5].textContent = results.aluminumDeck + ' ';
                materialQtys[6].textContent = results.ladderSets + ' ';
                materialQtys[7].textContent = results.guardrailLength + ' ';
                materialQtys[8].textContent = results.toeBoardLength + ' ';
                materialQtys[9].textContent = results.safetyNetArea + ' ';
                materialQtys[10].textContent = results.debrisNetArea + ' ';
                materialQtys[11].textContent = results.basePlates + ' ';
                materialQtys[12].textContent = results.adjustableJacks + ' ';
                materialQtys[13].textContent = results.wallTies + ' ';
                materialQtys[14].textContent = results.anchorBolts + ' ';
            }
            
            // Summary section
            const summaryValues = document.querySelectorAll('.summary-value');
            if (summaryValues.length >= 4) {
                summaryValues[0].textContent = results.totalTube + ' batang';
                summaryValues[1].textContent = results.estimatedWeight.toLocaleString() + ' kg';
                summaryValues[2].textContent = results.platformArea + ' m¬≤';
                summaryValues[3].textContent = Math.ceil(results.totalTube * 0.05) + ' batang';
            }
            
            // Engineering data
            const engineeringQtys = document.querySelectorAll('#engineering-tab .material-qty');
            if (engineeringQtys.length >= 8) {
                engineeringQtys[0].textContent = results.standardSpacing + ' m';
                engineeringQtys[1].textContent = results.ledgerSpacing + ' m';
                engineeringQtys[2].textContent = results.ledgerSpacing + ' m';
                engineeringQtys[3].textContent = results.lifts;
                engineeringQtys[4].textContent = results.tieHorizontalSpacing + ' m';
                engineeringQtys[5].textContent = results.tieVerticalSpacing + ' m';
                engineeringQtys[6].textContent = results.wallTies + ' pcs';
                engineeringQtys[7].textContent = 'Chemical Anchor';
            }
            
            // Safety checks
            document.getElementById('ratio-check').textContent = safetyCheck.heightRatio.toFixed(1) + ':1';
            document.getElementById('ratio-check').style.color = safetyCheck.heightRatio > 4 ? '#E74C3C' : 
                                                                safetyCheck.heightRatio > 3 ? '#F39C12' : '#27AE60';
            
            const guardrailCheck = document.getElementById('guardrail-check');
            guardrailCheck.textContent = document.getElementById('guardrail').checked ? '‚úÖ Compliant' : '‚ùå Required';
            guardrailCheck.style.color = document.getElementById('guardrail').checked ? '#27AE60' : '#E74C3C';
            
            const ledgerCheck = document.getElementById('ledger-check');
            const loadClass = document.getElementById('load-class').value;
            ledgerCheck.textContent = loadClass === 'heavy' && results.doubleLedger ? '‚úÖ Double Ledger' : 
                                     loadClass === 'heavy' ? '‚ùå Required' : '‚úÖ Single OK';
            ledgerCheck.style.color = (loadClass === 'heavy' && results.doubleLedger) ? '#27AE60' : 
                                     (loadClass === 'heavy' ? '#E74C3C' : '#27AE60');
            
            const tieCheck = document.getElementById('tie-check');
            tieCheck.textContent = safetyCheck.heightRatio > 4 ? '‚ö° Immediate Required' : 
                                 safetyCheck.heightRatio > 3 ? '‚ö†Ô∏è Recommended' : '‚úÖ Not Required';
            tieCheck.style.color = safetyCheck.heightRatio > 4 ? '#E74C3C' : 
                                  safetyCheck.heightRatio > 3 ? '#F39C12' : '#27AE60';
            
            // Construction data
            const constructionQtys = document.querySelectorAll('#construction-tab .material-qty');
            if (constructionQtys.length >= 10) {
                constructionQtys[0].textContent = results.erectionHours + ' hours';
                constructionQtys[1].textContent = Math.ceil(results.erectionHours / 8) + ' persons';
                constructionQtys[2].textContent = Math.ceil(results.erectionHours / 8) + ' days';
                constructionQtys[4].textContent = results.estimatedWeight.toLocaleString() + ' kg';
                constructionQtys[5].textContent = Math.ceil(results.totalTubeMeters * 0.001) + ' m¬≥';
                constructionQtys[6].textContent = Math.ceil(results.estimatedWeight / 20000) + ' loads';
                constructionQtys[7].textContent = results.estimatedWeight > 5000 ? 'Yes (10T)' : 'No';
                constructionQtys[8].textContent = results.dismantlingHours + ' hours';
                constructionQtys[9].textContent = Math.ceil(results.totalTubeMeters * 0.0001) + ' m¬≥';
            }
            
            // Safety notes
            const safetyNotes = document.getElementById('safety-notes');
            safetyNotes.innerHTML = '';
            
            if (safetyCheck.violations.length > 0) {
                safetyCheck.violations.forEach(violation => {
                    const li = document.createElement('li');
                    li.textContent = `‚ùå ${violation}`;
                    safetyNotes.appendChild(li);
                });
            }
            
            if (safetyCheck.warnings.length > 0) {
                safetyCheck.warnings.forEach(warning => {
                    const li = document.createElement('li');
                    li.textContent = `‚ö†Ô∏è ${warning}`;
                    safetyNotes.appendChild(li);
                });
            }
            
            // Add standard safety notes
            const standardNotes = [
                'Anchor capacity must be verified against concrete strength (minimum 25MPa)',
                'All connections must be torqued to manufacturer specification',
                'Daily inspection by competent person required before each shift',
                'Maximum wind speed: 50 km/h (scaffold must be evacuated above this limit)',
                'Load testing required if design load exceeds 75% of rated capacity'
            ];
            
            standardNotes.forEach(note => {
                const li = document.createElement('li');
                li.textContent = `üìù ${note}`;
                safetyNotes.appendChild(li);
            });
        }

        // Main calculation function
        function calculateScaffolding() {
            try {
                document.getElementById('loading-overlay').style.display = 'flex';
                updateComplianceStatus('Running Safety Checks...', 'warning');
                
                // Get inputs
                const length = parseFloat(document.getElementById('length').value);
                const width = parseFloat(document.getElementById('width').value);
                const height = parseFloat(document.getElementById('height').value);
                const systemType = document.getElementById('system-type').value;
                const loadClass = document.getElementById('load-class').value;
                const workingLevels = parseInt(document.getElementById('working-levels').value);
                
                // Get features
                const features = {
                    guardrail: document.getElementById('guardrail').checked,
                    toeBoards: document.getElementById('toe-boards').checked,
                    safetyNet: document.getElementById('safety-net').checked,
                    debrisNet: document.getElementById('debris-net').checked,
                    ladder: document.getElementById('ladder').checked,
                    platformBoards: document.getElementById('platform-boards').checked,
                    doubleLedger: loadClass === 'heavy', // Auto-enforce for heavy duty
                    secondarySupport: systemType === 'hanging',
                    extraBracing: workingLevels > 3
                };
                
                // Validate inputs
                if (length < 2 || width < 2 || height < 1) {
                    showError('Invalid dimensions. Minimum: 2m √ó 2m √ó 1m');
                    return;
                }
                
                // Update display
                document.getElementById('disp-length').textContent = length + ' m';
                document.getElementById('disp-width').textContent = width + ' m';
                document.getElementById('disp-height').textContent = height + ' m';
                document.getElementById('disp-load').textContent = 
                    document.getElementById('load-class').options[document.getElementById('load-class').selectedIndex].text.split(' ')[0];
                
                // Run safety validation
                const safetyCheck = validateSafety(length, width, height, loadClass, features);
                
                // Update compliance status
                if (!safetyCheck.isCompliant) {
                    updateComplianceStatus('‚ùå NON-COMPLIANT - Fix Required', 'danger');
                    document.getElementById('calculate-btn').disabled = true;
                    setTimeout(() => {
                        document.getElementById('loading-overlay').style.display = 'none';
                        alert('SAFETY VIOLATION:\n\n' + safetyCheck.violations.join('\n') + 
                              '\n\nScaffold design cannot be generated until violations are resolved.');
                    }, 1000);
                    return;
                } else if (safetyCheck.warnings.length > 0) {
                    updateComplianceStatus('‚ö†Ô∏è COMPLIANT with Recommendations', 'warning');
                    document.getElementById('calculate-btn').disabled = false;
                } else {
                    updateComplianceStatus('‚úÖ FULLY COMPLIANT', 'compliant');
                    document.getElementById('calculate-btn').disabled = false;
                }
                
                // Calculate materials
                const results = calculateMaterials(length, width, height, systemType, loadClass, features, workingLevels);
                
                // Display results
                displayResults(results, safetyCheck);
                
                // Generate 3D model
                setTimeout(() => {
                    drawScaffolding3D(length, width, height, systemType, loadClass, features, results);
                    document.getElementById('loading-overlay').style.display = 'none';
                }, 800);
                
            } catch (error) {
                console.error('Calculation error:', error);
                showError('System error occurred. Please check inputs and try again.');
                document.getElementById('loading-overlay').style.display = 'none';
            }
        }

        // ==================== EXPORT FUNCTIONS ====================

        // Toggle export menu
        function toggleExportMenu() {
            const menu = document.getElementById('export-menu');
            menu.classList.toggle('show');
            
            // Close menu when clicking outside
            setTimeout(() => {
                document.addEventListener('click', function closeMenu(e) {
                    if (!menu.contains(e.target) && !e.target.classList.contains('export-btn')) {
                        menu.classList.remove('show');
                        document.removeEventListener('click', closeMenu);
                    }
                });
            }, 0);
        }

        // Export to CSV
        function exportToCSV() {
            if (!currentCalculationData) {
                alert('Please calculate scaffolding first!');
                return;
            }
            
            const { results, safetyCheck, dimensions, system, loadClass, safetyStandard } = currentCalculationData;
            
            // Prepare CSV data
            let csvContent = "Scaffolding Design Report - Oil & Gas\n\n";
            
            // Project Information
            csvContent += "PROJECT INFORMATION\n";
            csvContent += `Timestamp,${new Date().toLocaleString()}\n`;
            csvContent += `Scaffolding System,${system}\n`;
            csvContent += `Load Classification,${loadClass}\n`;
            csvContent += `Safety Standard,${safetyStandard}\n`;
            csvContent += `Length,${dimensions.length} m\n`;
            csvContent += `Width,${dimensions.width} m\n`;
            csvContent += `Height,${dimensions.height} m\n`;
            csvContent += `Height-to-Base Ratio,${safetyCheck.heightRatio.toFixed(2)}:1\n`;
            csvContent += `Compliance Status,${safetyCheck.isCompliant ? 'Compliant' : 'Non-Compliant'}\n\n`;
            
            // Material Bill of Quantity
            csvContent += "BILL OF QUANTITY (BOQ)\n";
            csvContent += "Category,Material,Quantity,Unit\n";
            
            // Main Structure
            csvContent += "Main Structure,Vertical Standards (3m)," + results.verticalTube + ",batang\n";
            csvContent += "Main Structure,Horizontal Ledgers (3m)," + results.horizontalTube + ",batang\n";
            csvContent += "Main Structure,Diagonal Braces (3m)," + results.diagonalTube + ",batang\n";
            csvContent += "Main Structure,Transoms (2m)," + results.transomTube + ",batang\n";
            
            // Platform & Access
            csvContent += "Platform & Access,Steel Planks (3m)," + results.steelPlanks + ",pcs\n";
            csvContent += "Platform & Access,Aluminum Deck," + results.aluminumDeck + ",m¬≤\n";
            csvContent += "Platform & Access,Access Ladder," + results.ladderSets + ",set\n";
            
            // Safety Equipment
            csvContent += "Safety Equipment,Guardrail System," + results.guardrailLength + ",m\n";
            csvContent += "Safety Equipment,Toe Boards," + results.toeBoardLength + ",m\n";
            csvContent += "Safety Equipment,Safety Net," + results.safetyNetArea + ",m¬≤\n";
            csvContent += "Safety Equipment,Debris Net," + results.debrisNetArea + ",m¬≤\n";
            
            // Accessories
            csvContent += "Accessories,Base Plates," + results.basePlates + ",pcs\n";
            csvContent += "Accessories,Adjustable Jacks," + results.adjustableJacks + ",pcs\n";
            csvContent += "Accessories,Wall Ties," + results.wallTies + ",pcs\n";
            csvContent += "Accessories,Anchor Bolts," + results.anchorBolts + ",pcs\n\n";
            
            // Summary
            csvContent += "SUMMARY\n";
            csvContent += "Total Tube Required (3m)," + results.totalTube + ",batang\n";
            csvContent += "Total Estimated Weight," + results.estimatedWeight + ",kg\n";
            csvContent += "Projected Area," + results.platformArea + ",m¬≤\n";
            csvContent += "Material Wastage (5%)," + Math.ceil(results.totalTube * 0.05) + ",batang\n\n";
            
            // Safety Notes
            csvContent += "SAFETY NOTES\n";
            safetyCheck.violations.forEach(violation => {
                csvContent += "VIOLATION," + violation + "\n";
            });
            safetyCheck.warnings.forEach(warning => {
                csvContent += "WARNING," + warning + "\n";
            });
            
            // Download CSV
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `Scaffolding_Design_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();
            URL.revokeObjectURL(url);
            
            updateComplianceStatus('CSV Exported', 'safe');
        }

        // Export to Excel (XLSX)
        function exportToExcel() {
            if (!currentCalculationData) {
                alert('Please calculate scaffolding first!');
                return;
            }
            
            const { results, safetyCheck, dimensions, system, loadClass, safetyStandard, workingLevels } = currentCalculationData;
            
            // Prepare workbook
            const wb = XLSX.utils.book_new();
            
            // Sheet 1: Project Summary
            const summaryData = [
                ["SCAFFOLDING DESIGN REPORT - OIL & GAS"],
                ["Generated: " + new Date().toLocaleString()],
                [],
                ["PROJECT INFORMATION"],
                ["Scaffolding System", system],
                ["Load Classification", loadClass],
                ["Safety Standard", safetyStandard],
                ["Working Levels", workingLevels],
                ["Length", dimensions.length, "m"],
                ["Width", dimensions.width, "m"],
                ["Height", dimensions.height, "m"],
                ["Height-to-Base Ratio", safetyCheck.heightRatio.toFixed(2) + ":1"],
                ["Compliance Status", safetyCheck.isCompliant ? "‚úÖ Compliant" : "‚ùå Non-Compliant"],
                [],
                ["SAFETY CHECKS"],
                ["Height-to-Base Ratio", safetyCheck.heightRatio.toFixed(2) + ":1", safetyCheck.heightRatio > 4 ? "‚ùå Failed" : safetyCheck.heightRatio > 3 ? "‚ö†Ô∏è Warning" : "‚úÖ Passed"],
                ["Guardrail Compliance", document.getElementById('guardrail').checked ? "‚úÖ Compliant" : "‚ùå Required"],
                ["Double Ledger Check", loadClass === 'heavy' && results.doubleLedger ? "‚úÖ Double Ledger" : loadClass === 'heavy' ? "‚ùå Required" : "‚úÖ Single OK"],
                ["Tie Requirement", safetyCheck.heightRatio > 4 ? "‚ö° Immediate Required" : safetyCheck.heightRatio > 3 ? "‚ö†Ô∏è Recommended" : "‚úÖ Not Required"],
                [],
                ["SUMMARY"],
                ["Total Tube Required (3m)", results.totalTube, "batang"],
                ["Total Estimated Weight", results.estimatedWeight, "kg"],
                ["Projected Area", results.platformArea, "m¬≤"],
                ["Material Wastage (5%)", Math.ceil(results.totalTube * 0.05), "batang"],
                ["Erection Man-Hours", results.erectionHours, "hours"],
                ["Crew Size Required", Math.ceil(results.erectionHours / 8), "persons"],
                ["Erection Duration", Math.ceil(results.erectionHours / 8), "days"]
            ];
            
            const ws1 = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, ws1, "Summary");
            
            // Sheet 2: Materials BOQ
            const boqData = [
                ["BILL OF QUANTITY (BOQ)"],
                ["Category", "Material", "Quantity", "Unit"],
                
                // Main Structure
                ["MAIN STRUCTURE", "Vertical Standards (3m)", results.verticalTube, "batang"],
                ["MAIN STRUCTURE", "Horizontal Ledgers (3m)", results.horizontalTube, "batang"],
                ["MAIN STRUCTURE", "Diagonal Braces (3m)", results.diagonalTube, "batang"],
                ["MAIN STRUCTURE", "Transoms (2m)", results.transomTube, "batang"],
                
                // Platform & Access
                ["PLATFORM & ACCESS", "Steel Planks (3m)", results.steelPlanks, "pcs"],
                ["PLATFORM & ACCESS", "Aluminum Deck", results.aluminumDeck, "m¬≤"],
                ["PLATFORM & ACCESS", "Access Ladder", results.ladderSets, "set"],
                
                // Safety Equipment
                ["SAFETY EQUIPMENT", "Guardrail System", results.guardrailLength, "m"],
                ["SAFETY EQUIPMENT", "Toe Boards", results.toeBoardLength, "m"],
                ["SAFETY EQUIPMENT", "Safety Net", results.safetyNetArea, "m¬≤"],
                ["SAFETY EQUIPMENT", "Debris Net", results.debrisNetArea, "m¬≤"],
                
                // Accessories
                ["ACCESSORIES", "Base Plates", results.basePlates, "pcs"],
                ["ACCESSORIES", "Adjustable Jacks", results.adjustableJacks, "pcs"],
                ["ACCESSORIES", "Wall Ties", results.wallTies, "pcs"],
                ["ACCESSORIES", "Anchor Bolts", results.anchorBolts, "pcs"],
                
                // Totals
                [],
                ["TOTAL MATERIALS", "Total Tube (3m)", results.totalTube, "batang"],
                ["", "Total Weight", results.estimatedWeight, "kg"]
            ];
            
            const ws2 = XLSX.utils.aoa_to_sheet(boqData);
            XLSX.utils.book_append_sheet(wb, ws2, "Materials BOQ");
            
            // Sheet 3: Engineering Data
            const engineeringData = [
                ["ENGINEERING DATA"],
                ["Parameter", "Value", "Unit"],
                ["Standard Spacing", results.standardSpacing, "m"],
                ["Ledger Spacing", results.ledgerSpacing, "m"],
                ["Transom Spacing", results.transomSpacing, "m"],
                ["Bracing Interval", results.bracingInterval, "bays"],
                ["Lift Height", results.ledgerSpacing, "m"],
                ["Number of Lifts", results.lifts, ""],
                ["Horizontal Tie Spacing", results.tieHorizontalSpacing, "m"],
                ["Vertical Tie Spacing", results.tieVerticalSpacing, "m"],
                ["Total Wall Ties", results.wallTies, "pcs"],
                ["Anchor Bolt Type", "Chemical Anchor", ""],
                [],
                ["SAFETY VIOLATIONS"],
                ...safetyCheck.violations.map(v => [v]),
                [],
                ["SAFETY WARNINGS"],
                ...safetyCheck.warnings.map(w => [w])
            ];
            
            const ws3 = XLSX.utils.aoa_to_sheet(engineeringData);
            XLSX.utils.book_append_sheet(wb, ws3, "Engineering");
            
            // Sheet 4: Construction Data
            const constructionData = [
                ["CONSTRUCTION DATA"],
                ["Activity", "Value", "Unit"],
                ["Erection Man-Hours", results.erectionHours, "hours"],
                ["Crew Size Required", Math.ceil(results.erectionHours / 8), "persons"],
                ["Erection Duration", Math.ceil(results.erectionHours / 8), "days"],
                ["Scaffolder Level", "Advanced", ""],
                [],
                ["LOGISTICS"],
                ["Total Weight", results.estimatedWeight, "kg"],
                ["Volume Required", Math.ceil(results.totalTubeMeters * 0.001), "m¬≥"],
                ["Truck Loads", Math.ceil(results.estimatedWeight / 20000), "loads"],
                ["Crane Required", results.estimatedWeight > 5000 ? "Yes (10T)" : "No", ""],
                [],
                ["DISMANTLING"],
                ["Dismantling Man-Hours", results.dismantlingHours, "hours"],
                ["Waste Disposal", Math.ceil(results.totalTubeMeters * 0.0001), "m¬≥"],
                ["Cleaning Required", "4", "hours"],
                ["Inspection Post-Dismantle", "Required", ""]
            ];
            
            const ws4 = XLSX.utils.aoa_to_sheet(constructionData);
            XLSX.utils.book_append_sheet(wb, ws4, "Construction");
            
            // Generate and download Excel file
            XLSX.writeFile(wb, `Scaffolding_Design_${new Date().toISOString().slice(0,10)}.xlsx`);
            
            updateComplianceStatus('Excel Exported', 'safe');
        }

        // Export to PDF (simplified - using print)
        function exportToPDF() {
            if (!currentCalculationData) {
                alert('Please calculate scaffolding first!');
                return;
            }
            
            // Create a printable version
            const printContent = document.createElement('div');
            printContent.innerHTML = `
                <style>
                    body { font-family: Arial, sans-serif; margin: 20px; }
                    h1 { color: #2C3E50; }
                    h2 { color: #34495E; border-bottom: 2px solid #E74C3C; padding-bottom: 5px; }
                    table { width: 100%; border-collapse: collapse; margin: 15px 0; }
                    th { background: #2C3E50; color: white; padding: 10px; text-align: left; }
                    td { padding: 8px; border: 1px solid #ddd; }
                    .section { margin: 20px 0; }
                    .header { text-align: center; padding: 20px; background: #f5f5f5; }
                    .footer { margin-top: 30px; padding-top: 10px; border-top: 1px solid #ccc; font-size: 12px; }
                </style>
                <div class="header">
                    <h1>Scaffolding Design Report - Oil & Gas</h1>
                    <p>Generated: ${new Date().toLocaleString()}</p>
                </div>
                
                <div class="section">
                    <h2>Project Information</h2>
                    <table>
                        <tr><td><strong>Scaffolding System</strong></td><td>${currentCalculationData.system}</td></tr>
                        <tr><td><strong>Load Classification</strong></td><td>${currentCalculationData.loadClass}</td></tr>
                        <tr><td><strong>Dimensions</strong></td><td>${currentCalculationData.dimensions.length}m √ó ${currentCalculationData.dimensions.width}m √ó ${currentCalculationData.dimensions.height}m</td></tr>
                        <tr><td><strong>Compliance Status</strong></td><td>${currentCalculationData.safetyCheck.isCompliant ? '‚úÖ Compliant' : '‚ùå Non-Compliant'}</td></tr>
                    </table>
                </div>
                
                <div class="section">
                    <h2>Materials Bill of Quantity</h2>
                    <table>
                        <tr><th>Material</th><th>Quantity</th><th>Unit</th></tr>
                        <tr><td>Vertical Standards (3m)</td><td>${currentCalculationData.results.verticalTube}</td><td>batang</td></tr>
                        <tr><td>Horizontal Ledgers (3m)</td><td>${currentCalculationData.results.horizontalTube}</td><td>batang</td></tr>
                        <tr><td>Diagonal Braces (3m)</td><td>${currentCalculationData.results.diagonalTube}</td><td>batang</td></tr>
                        <tr><td>Steel Planks (3m)</td><td>${currentCalculationData.results.steelPlanks}</td><td>pcs</td></tr>
                        <tr><td>Guardrail System</td><td>${currentCalculationData.results.guardrailLength}</td><td>m</td></tr>
                        <tr><td>Wall Ties</td><td>${currentCalculationData.results.wallTies}</td><td>pcs</td></tr>
                    </table>
                </div>
                
                <div class="section">
                    <h2>Safety Notes</h2>
                    <ul>
                        ${currentCalculationData.safetyCheck.violations.map(v => `<li>‚ùå ${v}</li>`).join('')}
                        ${currentCalculationData.safetyCheck.warnings.map(w => `<li>‚ö†Ô∏è ${w}</li>`).join('')}
                    </ul>
                </div>
                
                <div class="footer">
                    <p><strong>Disclaimer:</strong> This report is generated automatically. All designs must be verified by a certified engineer.</p>
                    <p>¬© Oil & Gas Scaffolding Calculator - HSE Compliant Design Tool</p>
                </div>
            `;
            
            // Open print dialog
            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent.innerHTML);
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
            printWindow.close();
            
            updateComplianceStatus('PDF Generated', 'warning');
        }

        // Export Material List Only
        function exportMaterialList() {
            if (!currentCalculationData) {
                alert('Please calculate scaffolding first!');
                return;
            }
            
            const { results } = currentCalculationData;
            
            let csvContent = "MATERIAL LIST - SCAFFOLDING PROJECT\n\n";
            csvContent += "Item,Quantity,Unit,Notes\n";
            
            csvContent += `Vertical Standards (3m),${results.verticalTube},batang,Galvanized steel\n`;
            csvContent += `Horizontal Ledgers (3m),${results.horizontalTube},batang,Galvanized steel\n`;
            csvContent += `Diagonal Braces (3m),${results.diagonalTube},batang,Galvanized steel\n`;
            csvContent += `Transoms (2m),${results.transomTube},batang,Galvanized steel\n`;
            csvContent += `Steel Planks (3m),${results.steelPlanks},pcs,Checkered pattern\n`;
            csvContent += `Guardrail System,${results.guardrailLength},m,With mid rail\n`;
            csvContent += `Toe Boards,${results.toeBoardLength},m,200mm height\n`;
            csvContent += `Safety Net,${results.safetyNetArea},m¬≤,UV resistant\n`;
            csvContent += `Base Plates,${results.basePlates},pcs,200x200mm\n`;
            csvContent += `Adjustable Jacks,${results.adjustableJacks},pcs,500mm adjustment\n`;
            csvContent += `Wall Ties,${results.wallTies},pcs,Cup lock type\n`;
            csvContent += `Anchor Bolts,${results.anchorBolts},pcs,M16 chemical anchor\n`;
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `Material_List_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();
            URL.revokeObjectURL(url);
            
            updateComplianceStatus('Material List Exported', 'safe');
        }

        // Export Safety Report
        function exportSafetyReport() {
            if (!currentCalculationData) {
                alert('Please calculate scaffolding first!');
                return;
            }
            
            const { safetyCheck, dimensions } = currentCalculationData;
            
            let csvContent = "SAFETY INSPECTION REPORT - SCAFFOLDING\n\n";
            csvContent += "Project: Scaffolding Design\n";
            csvContent += `Date: ${new Date().toLocaleString()}\n`;
            csvContent += `Dimensions: ${dimensions.length}m √ó ${dimensions.width}m √ó ${dimensions.height}m\n\n`;
            
            csvContent += "SAFETY CHECKS\n";
            csvContent += "Check,Status,Remarks\n";
            csvContent += `Height-to-Base Ratio (max 4:1),${safetyCheck.heightRatio.toFixed(2)}:1,${safetyCheck.heightRatio > 4 ? 'FAIL' : safetyCheck.heightRatio > 3 ? 'WARNING' : 'PASS'}\n`;
            csvContent += `Guardrail System (required >2m),${document.getElementById('guardrail').checked ? 'INSTALLED' : 'MISSING'},${document.getElementById('guardrail').checked ? 'PASS' : 'FAIL'}\n`;
            csvContent += `Toe Boards (required >1.2m),${document.getElementById('toe-boards').checked ? 'INSTALLED' : 'MISSING'},${document.getElementById('toe-boards').checked ? 'PASS' : 'FAIL'}\n`;
            csvContent += `Access Ladder,${document.getElementById('ladder').checked ? 'PROVIDED' : 'MISSING'},${document.getElementById('ladder').checked ? 'PASS' : 'FAIL'}\n`;
            csvContent += `Platform Boards,${document.getElementById('platform-boards').checked ? 'INSTALLED' : 'MISSING'},${document.getElementById('platform-boards').checked ? 'PASS' : 'FAIL'}\n\n`;
            
            if (safetyCheck.violations.length > 0) {
                csvContent += "CRITICAL VIOLATIONS\n";
                safetyCheck.violations.forEach((v, i) => {
                    csvContent += `${i+1}. ${v}\n`;
                });
                csvContent += "\n";
            }
            
            if (safetyCheck.warnings.length > 0) {
                csvContent += "WARNINGS & RECOMMENDATIONS\n";
                safetyCheck.warnings.forEach((w, i) => {
                    csvContent += `${i+1}. ${w}\n`;
                });
                csvContent += "\n";
            }
            
            csvContent += "INSPECTOR SIGN-OFF\n";
            csvContent += "Inspected by: ____________________\n";
            csvContent += "Date: ____________________________\n";
            csvContent += "Status: ‚ñ° Approved  ‚ñ° Rejected  ‚ñ° Needs Review\n";
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `Safety_Report_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();
            URL.revokeObjectURL(url);
            
            updateComplianceStatus('Safety Report Exported', 'safe');
        }

        // Export All Reports (simulated ZIP)
        function exportAllReports() {
            if (!currentCalculationData) {
                alert('Please calculate scaffolding first!');
                return;
            }
            
            // In a real implementation, you would use a ZIP library like JSZip
            // Here we'll export the Excel file which contains multiple sheets
            exportToExcel();
            
            setTimeout(() => {
                // Export additional individual files
                exportToCSV();
                exportSafetyReport();
                
                updateComplianceStatus('Multiple Reports Generated', 'safe');
                alert('Multiple reports have been generated:\n1. Excel (XLSX) with all data\n2. CSV summary\n3. Safety report');
            }, 1000);
        }

        // Utility functions
        function showError(message) {
            alert(`HSE ALERT: ${message}`);
            updateComplianceStatus('Input Error', 'danger');
        }

        function onWindowResize() {
            const container = document.getElementById('canvas-container');
            if (camera && renderer) {
                camera.aspect = container.clientWidth / container.clientHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(container.clientWidth, container.clientHeight);
            }
        }

        function animate() {
            requestAnimationFrame(animate);
            if (controls) controls.update();
            if (renderer && scene && camera) {
                renderer.render(scene, camera);
            }
        }

        // Initialize on load
        window.addEventListener('load', () => {
            init3D();
            
            // Auto-update on input changes
            const inputs = ['length', 'width', 'height', 'system-type', 'load-class', 'safety-standard', 'working-levels'];
            inputs.forEach(id => {
                document.getElementById(id).addEventListener('change', () => {
                    document.getElementById('calculate-btn').disabled = false;
                });
            });
            
            const checkboxes = ['guardrail', 'toe-boards', 'safety-net', 'debris-net', 'ladder', 'platform-boards', 'uneven-ground', 'adjacent-structure'];
            checkboxes.forEach(id => {
                document.getElementById(id).addEventListener('change', () => {
                    document.getElementById('calculate-btn').disabled = false;
                });
            });
            
            // Initial calculation
            setTimeout(calculateScaffolding, 1500);
        });

        window.addEventListener('resize', onWindowResize);
    </script>
</body>
</html>
